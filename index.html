<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ’åº§ä½ï¼ˆ3Ã—10ï½œå¯æ”œå¼ï¼‹ä¸Šå‚³å³å£“ç¸®ï½œPadletå³éµè²¼ä¸Šï½œGASåŒ¯å…¥ï¼‹è¨­å®šé è¦½/å‹¾é¸ï¼‰</title>
<style>
  :root{ --bg:#f7f7fb; --ink:#222; --muted:#6b7280; --brand:#2563eb; --card:#fff; --line:#e5e7eb; --cell:150px; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,sans-serif}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);z-index:10}
  .bar{display:flex;flex-direction:column;gap:.5rem;padding:.6rem .8rem}
  .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
  .group{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;background:#fafafe;border:1px solid var(--line);padding:.35rem .5rem;border-radius:10px}
  .tabs{display:flex;gap:.5rem;flex:1;min-width:240px;overflow:auto}
  .tab{padding:.35rem .65rem;border:1px solid var(--line);background:#fff;border-radius:999px;cursor:pointer;white-space:nowrap}
  .tab.active{border-color:var(--brand);color:#fff;background:var(--brand)}
  .btn{padding:.45rem .7rem;border:1px solid var(--line);background:#fff;border-radius:10px;cursor:pointer;white-space:nowrap}
  .btn.primary{background:var(--brand);color:#fff;border-color:#2563eb}
  .btn.danger{background:#ef4444;color:#fff;border-color:#ef4444}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .sizeCtl{display:flex;align-items:center;gap:.4rem;border:1px solid var(--line);background:#fff;border-radius:10px;padding:.35rem .6rem}
  .sizeCtl input{width:160px}
  .status{font-size:.86rem;color:#111827;background:#eef2ff;border:1px solid #c7d2fe;border-radius:10px;padding:.35rem .6rem;display:flex;align-items:center;gap:.5rem}
  .dot{width:8px;height:8px;border-radius:50%}
  .ok{background:#22c55e}.warn{background:#f59e0b}.bad{background:#ef4444}

  main{padding:1rem;margin:0 auto}
  .stage{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:1rem}
  .grid{display:grid;grid-template-columns:repeat(10, var(--cell));gap:10px}

  .embedded main{padding:0.5rem;max-width:none;margin:0}
  .embedded .stage{border:none;border-radius:0}

  .seat{background:#fff;border:1px solid var(--line);border-radius:12px;padding:.5rem;display:flex;flex-direction:column;align-items:stretch;box-shadow:0 1px 0 rgba(0,0,0,.03)}
  .photo{position:relative;width:100%;aspect-ratio:1/1;border:1px dashed var(--line);border-radius:10px;background:#fafafa;overflow:hidden;cursor:pointer}
  .photo img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;pointer-events:none}
  .photo input[type=file]{display:none}
  .photo.hover{background:#f0f9ff}
  .info{margin-top:.45rem;display:flex;align-items:center;gap:.4rem}
  .no{flex:0 0 32px;height:32px;border:1px solid var(--line);border-radius:6px;display:flex;align-items:center;justify-content:center;background:#f9fafb;font-weight:600;font-size:.9rem}
  .name{flex:1;height:32px;display:flex;align-items:center}
  .name input{width:100%;height:32px;padding:.25rem .45rem;border:1px solid var(--line);border-radius:6px;font-size:.9rem}
  .name .text{width:100%;min-height:32px;border:1px solid var(--line);border-radius:6px;padding:.25rem .45rem;font-size:.9rem;background:#fff;display:flex;align-items:center}
  .name .text:hover{outline:2px solid #e0e7ff}

  dialog{border:none;border-radius:14px;padding:0;max-width:820px;width:calc(100% - 2rem)}
  dialog::backdrop{background:rgba(0,0,0,.35)}
  .sheet{padding:1rem;border-top:6px solid var(--brand);background:#fff;border-radius:14px}
  .sheet h3{margin:.2rem 0 .6rem}
  .row input[type=text], .row input[type=url]{padding:.5rem .6rem;border:1px solid var(--line);border-radius:8px;width:100%}
  .row textarea{width:100%;min-height:220px;padding:.7rem;border:1px solid var(--line);border-radius:10px;font-family:ui-monospace,Menlo,monospace}
  .help{font-size:.85rem;color:#6b7280}
  .right{display:flex;gap:.5rem;justify-content:flex-end}
  .small{font-size:.85rem}

  .rollBox{margin:.6rem 0;padding:1rem;border:2px dashed var(--line);border-radius:12px;background:#fafafa;display:flex;flex-direction:column;align-items:center;gap:.5rem}
  .rollNow{font-size:2.1rem;font-weight:800;letter-spacing:.02em}
  .rollSub{font-size:1rem;color:#6b7280}
  .badge{display:inline-flex;align-items:center;gap:.4rem;background:#eef2ff;color:#3730a3;border-radius:999px;padding:.25rem .6rem;font-weight:600}
  .flash{animation:flash 1.2s ease-out 1}
  @keyframes flash{0%{box-shadow:0 0 0 0 rgba(37,99,235,.8)}100%{box-shadow:0 0 0 16px rgba(37,99,235,0)}}

  /* å³éµè²¼ä¸Šï¼ˆPadletï¼‰æ™‚ä¸é¡¯ç¤ºæ¸¸æ¨™ */
  .photo[contenteditable="true"] { caret-color: transparent; }
  .photo[contenteditable="true"]:focus { outline: 2px solid #e0f2fe; }
  .photo[contenteditable="true"] * { user-select: none; }

  /* è¨­å®šé¢æ¿ï¼šé è¦½æ¸…å–® */
  .previewWrap{margin-top:.6rem;border:1px solid var(--line);border-radius:12px;padding:.6rem;background:#fafafa}
  .previewHead{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;margin-bottom:.4rem}
  .previewList{max-height:260px;overflow:auto;border:1px solid var(--line);border-radius:10px;background:#fff}
  .previewRow{display:grid;grid-template-columns: 32px 2fr 1fr 1fr;gap:.5rem;align-items:center;padding:.4rem .6rem;border-bottom:1px solid #f3f4f6}
  .previewRow:nth-child(even){background:#fafbff}
  .previewRow strong{font-weight:600}
  .previewRow small{color:#6b7280}

/* --- è¨ˆæ™‚å™¨æ¨£å¼ --- */
.timer{
  position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
  width:min(360px,92vw); background:#fff; border:1px solid var(--line);
  border-radius:14px; box-shadow:0 18px 36px rgba(0,0,0,.18); z-index:1000;
  user-select:none;
}
.timer-bar{
  display:flex; align-items:center; justify-content:space-between; gap:.5rem;
  padding:.5rem .6rem; background:#f8fafc; border-bottom:1px solid var(--line);
  cursor:move; border-radius:14px 14px 0 0;
}
.timer-body{ padding:.8rem }
.timer-face{
  font:700 3rem/1.1 ui-monospace,Menlo,monospace; letter-spacing:.04em;
  text-align:center; margin:.2rem 0 .6rem;
}
.timer-actions{ display:flex; gap:.5rem; justify-content:center }
.tbtn{ border:none; background:transparent; font-size:1.2rem; cursor:pointer; padding:.2rem .4rem }
@media (max-width:640px){
  .timer{ width:92vw }
  .timer-face{ font-size:2.6rem }
}

/* === å¹³æ™‚åˆ†æ•¸ï¼ˆæœ€å°è£œä¸ï¼‰ === */
.score-wrap{ margin-left:auto; display:flex; align-items:center; gap:.35rem; }
.score-badge{
  min-width:40px; height:28px; padding:0 .5rem;
  display:inline-flex; align-items:center; justify-content:center;
  border:1px solid var(--line); border-radius:999px; background:#f9fafb;
  font:600 .95rem/1.1 ui-monospace,Menlo,monospace;
}
.score-ctl{ display:flex; gap:.25rem; }
.score-ctl .mini{
  width:28px; height:28px; line-height:26px; padding:0;
  border:1px solid var(--line); background:#fff; border-radius:8px; cursor:pointer;
}
.score-ctl .mini:active{ transform:translateY(1px); }

/* === ç…§ç‰‡å…§è§’è½æŒ‰éˆ• + åº•éƒ¨æ¼¸å±¤ === */
.seat .photo{ position:relative; overflow:hidden; }

/* åº•éƒ¨æ¼¸å±¤ï¼šæ›´è–„ä¸€é»ï¼Œé¿å…åƒåˆ°å¤ªå¤šç…§ç‰‡ */
.seat .photo::after{
  content:"";
  position:absolute; left:0; right:0; bottom:0;
  height:16%; pointer-events:none;
  background:linear-gradient(to top, rgba(0,0,0,.18), rgba(0,0,0,0));
}

/* è§’è½ âˆ’ / ï¼‹ï¼šç¸®å°ã€é€æ˜åº¦é™ä¸€é»ã€å¾€è§’è½è²¼ç·Šäº› */
.corner-btn{
  position:absolute; bottom:8px;
  width:36px; height:36px; border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,.42); color:#fff;
  border:1px solid rgba(255,255,255,.35);
  box-shadow:0 2px 6px rgba(0,0,0,.20);
  font:700 1rem/1 ui-monospace,Menlo,monospace;
  cursor:pointer; user-select:none; z-index:2;
}
.corner-btn.left{  left:8px;  }
.corner-btn.right{ right:8px; }
.corner-btn:active{ transform:scale(.96); background:rgba(0,0,0,.56); }

/* å§“åä»åœ¨ç…§ç‰‡ä¸‹æ–¹ï¼Œå–®è¡Œçœç•¥è™Ÿ */
.seat .info .name .text{
  max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

/* ä»¥å‰æ”¾åœ¨ä¸‹æ–¹çš„ä¸€æ•´æ’åŠ åˆ†æ§åˆ¶åˆ—ï¼ˆè‹¥é‚„åœ¨ï¼‰å°±éš±è—æ‰ */
.seat .score-ctl-row{ display:none !important; }

/* ä¸Šæ–¹åº§è™Ÿï¼šç¶­æŒåœ“å½¢ 32px */
.no-badge{
  position:absolute; left:10px; top:10px;
  width:32px; height:32px; border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  background:rgba(255,255,255,.95);
  border:1px solid var(--line);
  font:700 .95rem/1 ui-monospace,Menlo,monospace; color:#111;
  z-index:2;
}

/* åˆ†æ•¸è† å›Š â†’ æ”¹ã€Œåœ“å½¢ã€32px */
.score-pill{
  position:absolute; right:10px; top:10px;
  width:32px; height:32px; border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  background:rgba(255,255,255,.95);
  border:1px solid var(--line);
  font:700 .95rem/1 ui-monospace,Menlo,monospace; color:#111;
  z-index:2;
}
/* æ­£è² è‰²ä»ä¿ç•™ï¼Œä½†ä»¥æ·¡è‰²åœˆé»äº®åœ“å½¢ */
.score-pill.pos{ background:#e8f7ee; border-color:#b7e3c8; }
.score-pill.neg{ background:#fdeaea; border-color:#f3c2c2; }

/* å¼·åˆ¶åˆ†æ•¸ç‚ºåœ“å½¢ï¼ˆè¦†è“‹èˆŠçš„ min-width / paddingï¼‰ */
.seat .photo .score-pill{
  width:32px !important;
  height:32px !important;
  min-width:32px !important;
  padding:0 !important;
  border-radius:50% !important;
  display:flex; align-items:center; justify-content:center;
  box-sizing:border-box;
}

/* --- å¤–æ¡†å±¤æ¬¡ï¼šå¡ç‰‡æµ®èµ·æ„Ÿï¼ˆæ•´å¼µ seat å¡ç‰‡ï¼‰ --- */
.seat{
  transition: box-shadow .18s ease, transform .18s ease;
  box-shadow: 0 2px 10px rgba(0,0,0,.06);
}
.seat:hover, .seat:focus-within{
  transform: translateY(-1px);
  box-shadow: 0 6px 22px rgba(0,0,0,.12);
}

/* --- åº•éƒ¨æ¼¸å±¤åœ¨ hover æ™‚ç¨å¾®åŠ å¼·ï¼Œè®“è§’è½æŒ‰éˆ•æ›´æ¸…æ¥š --- */
.seat .photo::after{ transition: opacity .18s ease; }
.seat:hover .photo::after{ opacity: .92; }

/* --- å¾½ç« é…è‰²ä¸€è‡´æ€§ï¼ˆåº§è™Ÿã€åˆ†æ•¸åŸºç¤å¤–è§€çµ±ä¸€ï¼‰ --- */
.seat .photo .no-badge,
.seat .photo .score-pill{
  background: rgba(255,255,255,.95);
  border: 1px solid rgba(0,0,0,.08);
  color:#111; box-shadow: 0 2px 6px rgba(0,0,0,.08);
}

/* åˆ†æ•¸å›ºå®šåœ“å½¢ï¼Œä¸¦å…è¨± JS ä»¥ inline style è¦†è“‹èƒŒæ™¯è‰²/æé‚Š */
.seat .photo .score-pill{
  width:32px !important; height:32px !important; min-width:32px !important;
  padding:0 !important; border-radius:50% !important;
  display:flex; align-items:center; justify-content:center;
  box-sizing:border-box;
  transition: transform .12s ease, background-color .18s ease, border-color .18s ease;
}

/* åº•éƒ¨è§’è½ +/- åœ¨ hover æ™‚ç•¥äº® */
.corner-btn{ transition: transform .12s ease, background-color .12s ease, box-shadow .12s ease; }
.seat:hover .corner-btn{ background: rgba(0,0,0,.48); box-shadow:0 3px 8px rgba(0,0,0,.28); }

/* --- åˆ†æ•¸å½ˆè·³æ•ˆæœï¼ˆJS æœƒåŠ  .pulse é¡ï¼‰ --- */
.score-pill.pulse{ animation: pill-pop .24s ease; }
@keyframes pill-pop{
  0%{ transform: scale(1); }
  50%{ transform: scale(1.18); }
  100%{ transform: scale(1); }
}

/* --- +1 / -1 å°æ³¡æ³¡ä¸Šé£„ï¼ˆJS æœƒå»ºç«‹ .delta-float å…ƒç´ ï¼‰ --- */
.delta-float{
  position:absolute; right:10px; top:10px;
  font:700 .9rem/1 ui-monospace,Menlo,monospace; pointer-events:none; z-index:3;
  transform: translateY(0); opacity:0; filter: drop-shadow(0 1px 2px rgba(0,0,0,.2));
  will-change: transform, opacity;
}
.delta-float.show{ animation: delta-up .6s ease forwards; }
@keyframes delta-up{
  0%  { transform: translateY(6px); opacity:0; }
  20% { opacity:1; }
  100%{ transform: translateY(-18px); opacity:0; }
}

/* === å§“åé¡¯ç¤ºå€ === */
.seat .info .name{
  text-align:center;
  margin-top:6px;          /* èˆ‡ç…§ç‰‡åº•éƒ¨ç•™è· */
}

.seat .info .name .text{
  display:inline-block;
  background:#fff;          /* ç™½åº•è®“å­—æ›´ä¹¾æ·¨ */
  padding:4px 10px;         /* è®“æ–‡å­—æœ‰ç•™ç™½ */
  border-radius:8px;        /* æŸ”å’Œåœ“è§’ */
  font-weight:600;          /* åŠ ç²— */
  color:#111827;            /* æ·±ç°æ–‡å­—ï¼Œæ¯”ç´”é»‘æŸ”å’Œ */
  font-size:1rem;           /* å­—ç¨å¤§ */
  letter-spacing:0.03em;    /* å­—è·ç•¥å¯¬ï¼Œè¦–è¦ºç©©å®š */
  box-shadow:0 1px 2px rgba(0,0,0,.06); /* å¾®é™°å½±å±¤æ¬¡ */
}

/* === å…¨ç«™çµ±ä¸€æŒ‰éˆ•æ¨£å¼ï¼ˆåŒ…å«åŒ¯å‡ºï¼åŒ¯å…¥ï¼‰ === */
button.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  height:40px;              /* å›ºå®šé«˜åº¦ */
  min-width:110px;          /* å›ºå®šå¯¬åº¦ï¼Œå¯è¦–å­—é•·èª¿æ•´ */
  padding:0 14px;           /* å·¦å³ç•™ç™½ */
  font-size:0.95rem;        /* çµ±ä¸€å­—é«”å¤§å° */
  font-weight:500;
  border:1px solid #ccc;
  border-radius:10px;
  background:#fff;
  color:#111;
  box-sizing:border-box;
  cursor:pointer;
  transition:all .15s ease;
}

button.btn:hover{
  background:#f9fafb;
  border-color:#bbb;
  transform:translateY(-1px);
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}

button.btn:active{
  transform:translateY(0);
/* ===== å·¥å…·åˆ—ï¼šæ”¶ç·Šé–“è·ï¼ˆè¦†è“‹åŸæœ¬çš„ gap / paddingï¼‰ ===== */
.bar{ gap:.4rem; }
.row{ gap:.4rem; }
.group{ gap:.35rem; padding:.25rem .4rem; }

/* ===== æ¬¡è¦æŒ‰éˆ•ï¼šå°å°ºå¯¸ç‰ˆæœ¬ï¼ˆçµ¦ä¸å¸¸ç”¨åŠŸèƒ½ï¼‰ ===== */
button.btn.sm{
  height:32px;
  min-width:auto;           /* è®“å¯¬åº¦è·Ÿå­—é•·èµ°ï¼Œä¸æœƒæ’å¤ªå¯¬ */
  padding:0 10px;
  font-size:.9rem;
  border-radius:8px;
}

/* å°æŒ‰éˆ•çš„ hover/active ä¹ŸåŒæ­¥ç¸®å°å‹•ä½œå¹…åº¦ */
button.btn.sm:hover{ transform:translateY(-1px); }
button.btn.sm:active{ transform:translateY(0); }
}

</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="row">
      <div class="tabs" id="tabs"></div>
      <div class="sizeCtl" title="èª¿æ•´å¡ç‰‡å¤§å°">
        <span>å°ºå¯¸</span>
        <input id="sizeRange" type="range" min="120" max="200" step="2" />
        <span id="sizeValue">150px</span>
      </div>
      <div class="status" id="fileStatus"><span class="dot warn"></span><span id="fileStatusText">æœªé€£çµè³‡æ–™æª”ï¼ˆä½¿ç”¨æœ¬æ©Ÿå„²å­˜ï¼‰</span></div>
    </div>
    <div class="row">
      <div class="group" title="ç­ç´šèˆ‡åå†Š">
        <button class="btn sm" id="addClassBtn" type="button">ï¼‹æ–°å¢ç­ç´š</button>
        <button class="btn sm" id="renameBtn" type="button">é‡æ–°å‘½å</button>
        <button class="btn danger sm" id="deleteClassBtn" type="button">ğŸ—‘åˆªé™¤ç­ç´š</button>
        <button class="btn sm" id="manualRosterBtn" type="button">æ‰‹å‹•åå†Š</button>
        <button class="btn sm" id="importGasBtn" type="button">â†¥å¾è©¦ç®—è¡¨åŒ¯å…¥(GAS)</button>
      </div>
      <div class="group" title="ä¸Šèª²è¼”åŠ©">
        <button class="btn" id="timerBtn" type="button">â±è¨ˆæ™‚å™¨</button>
        <button class="btn" id="drawBtn" type="button">ğŸ²æŠ½ç±¤é¢æ¿</button>
        <button class="btn" id="printBtn" type="button">åˆ—å°</button>
      </div>
      <div class="group" title="å¯æ”œå¼å°ˆæ¡ˆæª” / å‚™ä»½">
        <button class="btn sm" id="createFileBtn" type="button">ğŸ“ä¿å­˜è³‡æ–™æª”</button>
                 <button class="btn sm" id="linkFileBtn" type="button">ğŸ“‚é–‹å•Ÿè³‡æ–™æª”</button>
                 <button class="btn sm" id="unlinkFileBtn" type="button" disabled>âï¸å–æ¶ˆé€£çµ</button>
                 <button class="btn sm" id="backupBtn" type="button">åŒ¯å‡ºå‚™ä»½</button>
                 <label class="btn sm" for="restoreInput">åŒ¯å…¥å‚™ä»½</label>
        <input id="restoreInput" type="file" accept="application/json" style="display:none" />
      </div>
      <div class="group" title="è¨­å®š">
        <button class="btn sm" id="openSettingsBtn" type="button">âš™ï¸è¨­å®š</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="stage">
    <div id="grid" class="grid" aria-label="3åˆ— Ã— æ¯åˆ—10åº§ä½"></div>
  </div>
</main>

<!-- æ–°å¢/æ”¹åç­ç´š -->
<dialog id="classDlg">
  <form id="classForm" class="sheet">
    <h3 id="classDlgTitle">æ–°å¢ç­ç´š</h3>
    <div class="row"><input id="className" placeholder="ä¾‹å¦‚ï¼šå››å¹´ç”²ç­" required /></div>
    <div class="right">
      <button type="button" class="btn" id="cancelClassBtn">å–æ¶ˆ</button>
      <button type="submit" class="btn primary">ç¢ºå®š</button>
    </div>
  </form>
</dialog>

<!-- æ‰‹å‹•åŠ å…¥åå†Š -->
<dialog id="rosterDlg">
  <form id="rosterForm" class="sheet">
    <h3>æ‰‹å‹•åŠ å…¥åå†Šï¼ˆè²¼ä¸Šå³å¯ï¼‰</h3>
    <div class="help">æ¯è¡Œä¸€ä½ï¼š<code>1 ç‹å°æ˜</code> / <code>1,ç‹å°æ˜</code> / <code>1[TAB]ç‹å°æ˜</code>ï¼ˆå¯å«æ¨™é¡Œè¡Œï¼‰ã€‚</div>
    <div class="row"><textarea id="rosterText" placeholder="ä¾‹å¦‚ï¼š&#10;1 ç‹å°æ˜&#10;2 æå°è¯&#10;3 é™³å¤§åŒ"></textarea></div>
    <div class="row small">
      <label><input type="checkbox" id="overwriteChk" checked> è¦†è“‹å·²å­˜åœ¨å§“å</label>
      <label style="margin-left:1rem;"><input type="checkbox" id="clearMissingChk"> æ¸…ç©ºæœªå‡ºç¾åœ¨åå†Šä¸­çš„åº§ä½</label>
    </div>
    <div class="right">
      <button type="button" class="btn" id="cancelRosterBtn">å–æ¶ˆ</button>
      <button type="submit" class="btn primary">å¥—ç”¨åˆ°æœ¬ç­</button>
    </div>
  </form>
</dialog>

<!-- åˆªé™¤ç¢ºèª -->
<dialog id="deleteDlg">
  <div class="sheet">
    <h3>åˆªé™¤ç­ç´š</h3>
    <p id="deleteHint" style="margin:.2rem 0 .8rem;color:#374151"></p>
    <div class="right">
      <button type="button" class="btn" id="cancelDeleteBtn">å–æ¶ˆ</button>
      <button type="button" class="btn danger" id="confirmDeleteBtn">ç¢ºå®šåˆªé™¤</button>
    </div>
  </div>
</dialog>

<!-- æŠ½é¸å°è©±æ¡† -->
<dialog id="drawDlg">
  <div class="sheet">
    <h3>ğŸ² éš¨æ©ŸæŠ½é¸</h3>
    <div class="row">
      <label class="badge"><input type="radio" name="drawMode" value="person" checked> æŠ½äººï¼ˆæœ‰å§“åï¼‰</label>
      <label class="badge"><input type="radio" name="drawMode" value="seat"> æŠ½åº§ä½ï¼ˆ1â€“30ï¼‰</label>
      <label style="margin-left:1rem;"><input type="checkbox" id="skipEmptySeat" checked> ç•¥éç©ºä½</label>
      <label style="margin-left:1rem;"><input type="checkbox" id="avoidRepeats" checked> é¿å…é‡è¤‡</label>
    </div>
    <div class="rollBox">
      <div class="rollNow" id="rollNow">æº–å‚™ä¸­â€¦</div>
      <div class="rollSub" id="rollSub">æŒ‰ã€Œé–‹å§‹æŠ½ã€å•Ÿå‹•è·‘é¦¬ç‡ˆ</div>
      <canvas id="confetti" width="640" height="240" style="width:100%;height:160px;display:none;"></canvas>
    </div>
    <div class="row small" id="drawHistory" style="max-height:120px;overflow:auto;"></div>
    <div class="right">
      <button type="button" class="btn" id="resetDrawBtn">é‡ç½®æœ¬ç­æŠ½é¸ç´€éŒ„</button>
      <button type="button" class="btn primary" id="startDrawBtn">é–‹å§‹æŠ½</button>
      <button type="button" class="btn" id="closeDrawBtn">é—œé–‰</button>
    </div>
  </div>
</dialog>

<!-- è¨­å®šé¢æ¿ï¼ˆå«é è¦½/å‹¾é¸åŒ¯å…¥ï¼‰ -->
<dialog id="settingsDlg">
  <form id="settingsForm" class="sheet">
    <h3>âš™ï¸ è¨­å®š</h3>
    <div class="help">è«‹å…ˆéƒ¨ç½²ä½ çš„ GAS Web Appï¼ˆä»»ä½•äººå¯å­˜å–ï¼‰ï¼Œä¸¦æº–å‚™å¥½è©¦ç®—è¡¨ç¶²å€æˆ– IDã€‚E2 è²¼ã€Œå„ç­ç…§ç‰‡è³‡æ–™å¤¾ã€ç¶²å€ï¼ˆå¯ç©ºç™½ï¼‰ã€‚</div>
    <div class="row">
      <label style="width:100%">
        GAS Web App URL
        <input id="gasUrlInput" type="url" placeholder="https://script.google.com/macros/s/xxxx/exec" required />
      </label>
    </div>
    <div class="row">
      <label style="width:100%">
        è©¦ç®—è¡¨ç¶²å€æˆ– ID
        <input id="sheetIdInput" type="text" placeholder="æ•´æ®µç¶²å€æˆ–ç´” ID çš†å¯" required />
      </label>
    </div>
    <div class="row small">
      <label class="badge"><input type="checkbox" id="includePhotosChk" checked> é€£åŒç…§ç‰‡åŒ¯å…¥ï¼ˆè‹¥ E2 æœ‰è³‡æ–™å¤¾ï¼‰</label>
      <button type="button" class="btn" id="testFetchBtn">æ¸¬è©¦é€£ç·šä¸¦é è¦½</button>
      <span id="testResult" class="help"></span>
    </div>

    <div class="previewWrap" id="previewWrap" style="display:none">
      <div class="previewHead">
        <strong>ç­ç´šæ¸…å–®é è¦½</strong>
        <button type="button" class="btn small" id="selectAllBtn">å…¨é¸</button>
        <button type="button" class="btn small" id="selectNoneBtn">å…¨ä¸é¸</button>
        <button type="button" class="btn primary small" id="importSelectedBtn">åŒ¯å…¥å‹¾é¸ç­ç´š</button>
      </div>
      <div class="previewList" id="previewList" role="list"></div>
      <div class="help" id="previewHint" style="margin-top:.4rem"></div>
    </div>

    <div class="right" style="margin-top:.6rem">
      <button type="button" class="btn" id="cancelSettingsBtn">é—œé–‰</button>
      <button type="submit" class="btn">å„²å­˜è¨­å®š</button>
    </div>
  </form>
</dialog>

<!-- æµ®å‹•è¨ˆæ™‚å™¨ï¼ˆå¯æ‹–æ›³ï¼‰ -->
<div id="timerPanel" class="timer" style="display:none" role="dialog" aria-label="è¨ˆæ™‚å™¨">
  <div class="timer-bar" id="timerDragHandle">
    <strong>â± è¨ˆæ™‚å™¨</strong>
    <button id="timerClose" class="tbtn" type="button" aria-label="é—œé–‰">Ã—</button>
  </div>
  <div class="timer-body">
    <div id="timerDisplay" class="timer-face">00:00</div>
    <div class="timer-actions">
      <button id="timerStartPause" class="btn primary" type="button">é–‹å§‹</button>
      <button id="timerReset" class="btn" type="button">é‡è¨­</button>
    </div>
  </div>
</div>


<!-- éš±è—çš„æª”æ¡ˆé¸æ“‡å™¨ï¼ˆé»é¸ä¸Šå‚³ï¼‰ -->
<input id="fileProxy" type="file" accept="image/*"
       style="position:fixed;left:-9999px;opacity:0;width:1px;height:1px;pointer-events:none" />

<script>
/* ========= å¸¸æ•¸èˆ‡å·¥å…· ========= */
const $ = s => document.querySelector(s);
const ROWS = 3, COLS = 10;
const MAX_DIM = 720;
const IMG_TYPE_PREFERRED = 'image/webp';
const IMG_QUALITY = 0.78;
const LS_KEY = 'seating.3x10.portable.v6';
const LS_GAS_URL = 'seating.gas.endpoint.v1';
const LS_SHEET_ID = 'seating.sheet.id.v1';
const LS_LAST_PREVIEW = 'seating.last.preview.v1';

const supportsFSA = !!(window.showOpenFilePicker && window.FileSystemHandle);
if (window.self !== window.top) document.documentElement.classList.add('embedded');

/* ========= IndexedDBï¼šä¿å­˜æª”æ¡ˆ Handle ========= */
function idbOpen(){return new Promise((res,rej)=>{const r=indexedDB.open('seating-db',1);r.onupgradeneeded=e=>e.target.result.createObjectStore('handles');r.onsuccess=e=>res(e.target.result);r.onerror=()=>rej(r.error);});}
async function idbSet(k,v){const db=await idbOpen();return new Promise((res,rej)=>{const tx=db.transaction('handles','readwrite');tx.objectStore('handles').put(v,k);tx.oncomplete=res;tx.onerror=()=>rej(tx.error);});}
async function idbGet(k){const db=await idbOpen();return new Promise((res,rej)=>{const tx=db.transaction('handles','readonly');const rq=tx.objectStore('handles').get(k);rq.onsuccess=()=>res(rq.result);rq.onerror=()=>rej(rq.error);});}
async function idbDel(k){const db=await idbOpen();return new Promise((res,rej)=>{const tx=db.transaction('handles','readwrite');tx.objectStore('handles').delete(k);tx.oncomplete=res;tx.onerror=()=>rej(tx.error);});}

/* ========= å½±åƒå£“ç¸® ========= */
function fileToDataURL(file){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(file);});}
function dataURLToBlobURL(dataURL){const byteString=atob(dataURL.split(',')[1]);const mime=dataURL.split(';')[0].split(':')[1];const ab=new ArrayBuffer(byteString.length);const ia=new Uint8Array(ab);for(let i=0;i<byteString.length;i++)ia[i]=byteString.charCodeAt(i);const blob=new Blob([ab],{type:mime});return URL.createObjectURL(blob);}
async function compressDataURL(src,maxDim=MAX_DIM,type=IMG_TYPE_PREFERRED,quality=IMG_QUALITY){
  return await new Promise(resolve=>{
    const img=new Image();const tmpURL=dataURLToBlobURL(src);
    img.onload=()=>{
      let w=img.width,h=img.height;const max=Math.max(w,h);
      if(max>maxDim){const s=maxDim/max;w=Math.round(w*s);h=Math.round(h*s);}
      const cv=document.createElement('canvas');cv.width=w;cv.height=h;const cx=cv.getContext('2d');cx.drawImage(img,0,0,w,h);
      cv.toBlob(b=>{
        if(b){const fr=new FileReader();fr.onload=()=>{URL.revokeObjectURL(tmpURL);resolve(fr.result)};fr.readAsDataURL(b);}
        else{const fallback=cv.toDataURL('image/jpeg',0.82);URL.revokeObjectURL(tmpURL);resolve(fallback);}
      },type,quality);
    };
    img.onerror=()=>{URL.revokeObjectURL(tmpURL);resolve(src)};
    img.src=tmpURL;
  });
}
async function compressFile(file){const src=await fileToDataURL(file);return await compressDataURL(src);}
function isImageUrl(u){try{const url=new URL(u);if(!/^https?:$/i.test(url.protocol))return false;return /\.(png|jpe?g|gif|webp|bmp|svg)(\?|#|$)/i.test(url.pathname);}catch{return false;}}
function extractImgSrcFromHTML(html){if(!html)return'';let m=html.match(/<img[^>]+src=["']([^"']+)["']/i);if(m&&m[1])return m[1];m=html.match(/<img[^>]+srcset=["']([^"']+)["']/i);if(m&&m[1]){const first=m[1].split(',')[0].trim().split(/\s+/)[0];return first||''}return''}

/* ç›´æ¥åœ–ç‰‡èˆ‡ Padlet é™„ä»¶ */
function isDirectImageLink(u){try{const url=new URL(u);return /^https?:$/i.test(url.protocol)&&/\.(png|jpe?g|gif|webp|bmp|svg)(\?|#|$)/i.test(url.pathname);}catch{return false;}}
function isPadletAttachment(u){try{const host=new URL(u).host;return /padletuploads\.blob\.core\.windows\.net|padletusercontent|padlet\.net/i.test(host);}catch{return false;}}

/* === Google Drive é€£çµä¿®æ­£èˆ‡å‚™æ´ï¼ˆæ–°å¢ï¼‰ === */
function normalizeDriveImageURL(u){
  try{
    const url = new URL(u);
    if (!/drive\.google\.com$/i.test(url.hostname)) return u;
    const id = url.searchParams.get('id') || (url.pathname.match(/\/d\/([^/]+)/)||[])[1];
    if (!id) return u;
    return `https://drive.google.com/uc?export=view&id=${id}`;
  }catch{ return u; }
}
function altDriveThumbnailURL(u){
  const m = u.match(/id=([a-zA-Z0-9_-]+)/);
  if (!m) return null;
  const id = m[1];
  return `https://drive.google.com/thumbnail?id=${id}&sz=w800`;
}

/* ========= æŠ“å–å…ƒç´  ========= */
const tabsEl = $('#tabs'), gridEl = $('#grid');
const sizeRange = $('#sizeRange'), sizeValue = $('#sizeValue');
const classDlg = $('#classDlg'), classForm = $('#classForm'), classDlgTitle = $('#classDlgTitle'), classNameInput = $('#className');
const rosterDlg = $('#rosterDlg'), rosterForm = $('#rosterForm'), rosterText = $('#rosterText');
const overwriteChk = $('#overwriteChk'), clearMissingChk = $('#clearMissingChk');
const deleteDlg = $('#deleteDlg'), deleteHint = $('#deleteHint');
const drawDlg = $('#drawDlg');
const rollNow = $('#rollNow'), rollSub = $('#rollSub'), confettiCanvas = $('#confetti');
const startDrawBtn = $('#startDrawBtn'), closeDrawBtn = $('#closeDrawBtn'), resetDrawBtn = $('#resetDrawBtn');
const skipEmptySeat = $('#skipEmptySeat'), avoidRepeats = $('#avoidRepeats');
const linkFileBtn = $('#linkFileBtn'), createFileBtn = $('#createFileBtn'), unlinkFileBtn = $('#unlinkFileBtn'), fileStatus = $('#fileStatus'), fileStatusText = $('#fileStatusText');
const fileProxy = document.getElementById('fileProxy');
/* è¨ˆæ™‚å™¨å…ƒç´  */
const timerPanel = document.getElementById('timerPanel');
const timerBtn = document.getElementById('timerBtn');
const timerDisplay = document.getElementById('timerDisplay');
const timerStartPause = document.getElementById('timerStartPause');
const timerReset = document.getElementById('timerReset');
const timerClose = document.getElementById('timerClose');
const timerDragHandle = document.getElementById('timerDragHandle');

let fileProxyTargetKey = null;

/* è¨­å®šé¢æ¿å…ƒç´  */
const settingsDlg = $('#settingsDlg'), settingsForm = $('#settingsForm');
const gasUrlInput = $('#gasUrlInput'), sheetIdInput = $('#sheetIdInput');
const includePhotosChk = $('#includePhotosChk');
const testFetchBtn = $('#testFetchBtn'), testResult = $('#testResult');
const openSettingsBtn = $('#openSettingsBtn');
const previewWrap = $('#previewWrap'), previewList = $('#previewList'), previewHint = $('#previewHint');
const selectAllBtn = $('#selectAllBtn'), selectNoneBtn = $('#selectNoneBtn'), importSelectedBtn = $('#importSelectedBtn');

/* ========= ç‹€æ…‹èˆ‡æŒä¹…åŒ– ========= */
const uid = () => (crypto?.randomUUID?.() || 'id-' + Math.random().toString(36).slice(2));
const defaultClass = (name='æœªå‘½åç­ç´š') => ({ id: uid(), name, seats:{}, draws:{people:[], seats:[]} });

let state = loadLocal() || { classes:[ defaultClass() ], activeId:null, settings:{ cell:150 } };
if(!state.activeId) state.activeId = state.classes[0].id;
state.classes.forEach(c=>{ if(!c.draws) c.draws={people:[], seats:[]}; });

let projectHandle = null, saveTimer = null, saving = false, lastFileName = '';
let renameTargetId = null;
let lastPreview = loadPreview() || null;

function loadLocal(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)); }catch{ return null; } }
function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function getGasUrl(){ return localStorage.getItem(LS_GAS_URL)||''; }
function setGasUrl(v){ localStorage.setItem(LS_GAS_URL, v||''); }
function getSheetId(){ return localStorage.getItem(LS_SHEET_ID)||''; }
function setSheetId(v){ localStorage.setItem(LS_SHEET_ID, v||''); }
function savePreview(obj){ localStorage.setItem(LS_LAST_PREVIEW, JSON.stringify(obj||null)); }
function loadPreview(){ try{ return JSON.parse(localStorage.getItem(LS_LAST_PREVIEW)||'null'); }catch{return null;} }

function setStatus(text, level='warn'){
  fileStatusText.textContent = text;
  fileStatus.querySelector('.dot')?.classList.remove('ok','warn','bad');
  fileStatus.querySelector('.dot')?.classList.add(level);
}

function scheduleSave(){
  saveLocal();
  if(projectHandle){
    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(persistToFile, 450);
  }
}
async function persistToFile(){
  if(!projectHandle) return;
  if(saving){ saveTimer = setTimeout(persistToFile, 250); return; }
  try{
    saving = true;
    const writable = await projectHandle.createWritable();
    await writable.write(new Blob([JSON.stringify(state)], {type:'application/json'}));
    await writable.close();
    setStatus(`å·²å„²å­˜è‡³ï¼š${lastFileName}`, 'ok');
  }catch(err){ setStatus(`å¯«å…¥å¤±æ•—ï¼š${err.message}`, 'bad'); }
  finally{ saving = false; }
}
async function ensurePermission(handle, write=false){
  const mode = write ? 'readwrite' : 'read';
  const q = await handle.queryPermission({mode});
  if(q === 'granted') return true;
  const r = await handle.requestPermission({mode});
  return r === 'granted';
}
async function loadFromFile(){
  try{
    const file = await projectHandle.getFile();
    lastFileName = file.name;
    const text = await file.text();
    const data = JSON.parse(text||'{}');
    if(data && data.classes){
      data.classes.forEach(c=>{ if(!c.draws) c.draws={people:[],seats:[]}; });
      state = data;
      if(!state.settings) state.settings = {cell:150};
      setActive(state.activeId || state.classes[0]?.id || (state.classes[0]=defaultClass()).id);
      renderTabs(); renderGrid();
      sizeRange.value = state.settings.cell || 150; applyCellSize(state.settings.cell || 150);
      setStatus(`å·²é€£çµï¼š${file.name}`,'ok');
      unlinkFileBtn.disabled = false;
    }else{
      await persistToFile();
      setStatus(`å·²åˆå§‹åŒ–ï¼š${file.name}`,'ok');
      unlinkFileBtn.disabled = false;
    }
  }catch(err){
    setStatus(`å°šæœªæˆæ¬Šè®€å–ï¼ˆé»ä¸€ä¸‹é é¢è‡ªå‹•æˆæ¬Šä¸¦è¼‰å…¥ï¼‰`,'warn');
    const relink = async ()=>{
      try{ if(await ensurePermission(projectHandle, true)){ await loadFromFile(); } }catch(e){}
      document.removeEventListener('pointerdown', relink);
    };
    document.addEventListener('pointerdown', relink, {once:true});
  }
}

/* ========= UI / ç­ç´š =========== */
function active(){ return state.classes.find(c=>c.id===state.activeId); }
function setActive(id){ state.activeId=id; scheduleSave(); renderTabs(); renderGrid(); }
function seatKey(r,c){ return `R${r}-C${c}`; }
function seatNo(r,c){ return (r-1)*COLS + c; }
function openDlg(dlg){ dlg.showModal ? dlg.showModal() : dlg.setAttribute('open',''); }
function closeDlg(dlg){ dlg.close ? dlg.close() : dlg.removeAttribute('open'); }

function seatCard(cls, r, c){
  const k = seatKey(r,c);
  const data = cls.seats[k] || { name:'', img:'' };

  const seat = document.createElement('div'); seat.className='seat'; seat.dataset.key=k;

  const photo = document.createElement('div'); photo.className='photo';
  const file = document.createElement('input'); file.type='file'; file.accept='image/*';
  photo.appendChild(file);

  if (data.img){
    const img = document.createElement('img');
    img.referrerPolicy = 'no-referrer';                 // â† æ–°å¢ï¼šé¿å…æŸäº›ä¾†æºæ“‹å¤–ç«™
    const first = normalizeDriveImageURL(data.img);     // â† æ–°å¢ï¼šDrive é€£çµæ­£è¦åŒ–
    img.src = first;
    img.onerror = () => {                               // â† æ–°å¢ï¼šå¤±æ•—æ”¹ç”¨ thumbnail å‚™æ´
      if (img.dataset.triedAlt) return;
      const alt = altDriveThumbnailURL(img.src);
      if (alt){ img.dataset.triedAlt = '1'; img.src = alt; }
    };
    photo.appendChild(img);
  }

  // å³éµ/å¿«æ·éµè²¼ä¸Šï¼ˆå« Padlet é™„ä»¶ URLï¼‰
  photo.setAttribute('contenteditable', 'true');
  photo.setAttribute('spellcheck', 'false');
  photo.setAttribute('aria-label', 'ç…§ç‰‡å€å¡Šï¼šå¯å³éµæˆ– Ctrl+V è²¼ä¸Šåœ–ç‰‡æˆ–åœ–ç‰‡ç¶²å€ï¼ˆå« Padlet é™„ä»¶ï¼‰');
  photo.addEventListener('beforeinput', e => e.preventDefault());
  photo.addEventListener('keydown', e => { if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) e.preventDefault(); });
  photo.addEventListener('paste', async (e) => {
    const key = k;
    const cd = e.clipboardData;
    const target = cls.seats[key] || { name: data.name || '', img: data.img || '' };
    for (const item of cd.items) {
      if (item.type && item.type.startsWith('image/')) {
        const f = item.getAsFile();
        if (f) { target.img = await compressFile(f); cls.seats[key] = target; scheduleSave(); renderGrid(); e.preventDefault(); return; }
      }
    }
    const txt = cd.getData('text/plain')?.trim();
    if (txt && (isDirectImageLink(txt) || isPadletAttachment(txt) || /^data:image\//i.test(txt))) {
      target.img = /^data:image\//i.test(txt) ? await compressDataURL(txt) : normalizeDriveImageURL(txt);
      cls.seats[key] = target; scheduleSave(); renderGrid(); e.preventDefault();
    }
  });

  const info = document.createElement('div'); info.className='info';
  const no = document.createElement('div'); no.className='no'; no.textContent=seatNo(r,c);
  const nameWrap = document.createElement('div'); nameWrap.className='name';
  if(data.name){
    const div=document.createElement('div'); div.className='text'; div.textContent=data.name; div.title='é»æ“Šä»¥é‡æ–°è¼¸å…¥å§“å';
    div.addEventListener('click', ()=>{ data.name=''; cls.seats[k]=data; scheduleSave(); renderGrid(); });
    nameWrap.appendChild(div);
  }else{
    const input=document.createElement('input'); input.placeholder='å§“å';
    input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); input.blur(); }});
    input.addEventListener('change', ()=>{ data.name=input.value.trim(); cls.seats[k]=data; scheduleSave(); renderGrid(); });
    nameWrap.appendChild(input);
  }
      
    // === åˆ†æ•¸ï¼šé è¨­ 0ï¼ŒèˆŠè³‡æ–™è‡ªå‹•è£œ ===
if (typeof data.score !== 'number') data.score = 0;

/* â”€â”€ ä¸Šæ–¹ï¼šåº§è™Ÿï¼ˆå·¦ä¸Šï¼Œåœ“å½¢ï¼‰ â”€â”€ */
const noBadge = document.createElement('div');
noBadge.className = 'no-badge';
noBadge.textContent = seatNo(r, c);
photo.appendChild(noBadge);

/* â”€â”€ ä¸Šæ–¹ï¼šåˆ†æ•¸ï¼ˆå³ä¸Šï¼Œåœ“å½¢ï¼Œæ­£è² è®Šè‰²ï¼‰ â”€â”€ */
const scorePill = document.createElement('div');
scorePill.className = 'score-pill';
photo.appendChild(scorePill);

const setPill = (v) => {
  const n = Number(v) || 0;
  scorePill.textContent = (n > 0 ? '+' : '') + String(n);

  // ä¾çµ•å°å€¼èª¿æ•´å¼·åº¦ï¼ˆ0~5 å°æ˜  0~1ï¼‰ï¼Œå¯è¦–éœ€è¦èª¿æ•´ maxMag
  const mag = Math.min(Math.abs(n), 5) / 5; // 0 ~ 1
  if (n > 0){
    // ç¶ è‰²ç³»ï¼šç”±æ·¡åˆ°ç¨æ·±ï¼ˆHSL æ›´æŸ”å’Œï¼‰
    const bg = `hsl(142 60% ${95 - mag*18}%)`;
    const bd = `hsl(142 45% ${78 - mag*20}%)`;
    scorePill.style.backgroundColor = bg;
    scorePill.style.borderColor = bd;
    scorePill.style.color = '#0b5d33';
  }else if(n < 0){
    // ç´…è‰²ç³»ï¼šç”±æ·¡åˆ°ç¨æ·±
    const bg = `hsl(0 75% ${95 - mag*18}%)`;
    const bd = `hsl(0 58% ${78 - mag*20}%)`;
    scorePill.style.backgroundColor = bg;
    scorePill.style.borderColor = bd;
    scorePill.style.color = '#7b1d1d';
  }else{
    // 0 åˆ†ï¼šä¸­æ€§
    scorePill.style.backgroundColor = 'rgba(255,255,255,.95)';
    scorePill.style.borderColor = 'rgba(0,0,0,.08)';
    scorePill.style.color = '#111';
  }
};

/* â”€â”€ åº•éƒ¨è§’è½ï¼šç…§ç‰‡å…§çš„ ï¼ / ï¼‹ åœ“å½¢æŒ‰éˆ• â”€â”€ */
const btnMinusCorner = document.createElement('button');
btnMinusCorner.type = 'button';
btnMinusCorner.className = 'corner-btn left';
btnMinusCorner.setAttribute('aria-label', 'æ‰£åˆ†');
btnMinusCorner.textContent = 'âˆ’';

const btnPlusCorner = document.createElement('button');
btnPlusCorner.type = 'button';
btnPlusCorner.className = 'corner-btn right';
btnPlusCorner.setAttribute('aria-label', 'åŠ åˆ†');
btnPlusCorner.textContent = '+';

photo.appendChild(btnMinusCorner);
photo.appendChild(btnPlusCorner);

// è®“ + / - è‡ªå·±åƒæ‰ clickï¼ˆé¿å…å†’æ³¡åˆ° photo çš„ clickï¼‰
const swallow = e => { e.preventDefault(); e.stopPropagation(); };
btnPlusCorner.addEventListener('click', swallow, true);
btnMinusCorner.addEventListener('click', swallow, true);

/* â”€â”€ å®‰å…¨å„²å­˜ï¼šå°ˆæ¡ˆæ²’æœ‰ scheduleSave ä¹Ÿä¸æœƒå™´éŒ¯ â”€â”€ */
function requestSave() {
  try {
    if (typeof scheduleSave === 'function') scheduleSave();
    else if (typeof saveState === 'function') saveState();
    else if (typeof persist === 'function') persist();
  } catch (e) {
    console.warn('skip save:', e);
  }
}

/* â”€â”€ å–®ä¸€å…¥å£ï¼šæ›´æ–°åˆ†æ•¸ â”€â”€ */
function updateScore(delta){
  data.score = (Number(data.score)||0) + delta;
  cls.seats[k] = data;

  // è¦–è¦ºï¼šåˆ†æ•¸å¾½ç« å½ˆè·³
  scorePill.classList.remove('pulse'); // é‡æ–°è§¸ç™¼å‹•ç•«
  void scorePill.offsetWidth;          // å¼·åˆ¶é‡æ’
  scorePill.classList.add('pulse');

  // è¦–è¦ºï¼š+1 / -1 å°æ³¡æ³¡
  const df = document.createElement('div');
  df.className = 'delta-float show';
  df.style.color = delta>0 ? '#0b5d33' : '#7b1d1d';
  df.textContent = (delta>0?'+':'') + String(delta);
  photo.appendChild(df);
  setTimeout(()=> df.remove(), 650);

  // æ›´æ–°å¤–è§€èˆ‡å„²å­˜
  setPill(data.score);
  requestSave();
}

/* â”€â”€ ä¿®æ­£ã€Œé»ä¸€ä¸‹è·³ 2 åˆ†ã€ï¼šæ”¹ç”¨ pointer äº‹ä»¶ â”€â”€
   çŸ­æŒ‰ <300msï¼šåª Â±1
   é•·æŒ‰ â‰¥300msï¼šé–‹å§‹é€£çºŒ Â±ï¼ˆæ¯ 140ms ä¸€æ¬¡ï¼‰ï¼Œæ”¾é–‹åœæ­¢
*/
function bindPressRepeat(btn, delta) {
  let timer = null;       // setTimeout æˆ– setInterval çš„è­˜åˆ¥
  let isRepeating = false;
  let downAt = 0;

  const start = (ev) => {
    ev.preventDefault();
    ev.stopPropagation();
    downAt = performance.now();

    // 300ms å¾Œæ‰é€²å…¥é€£çºŒæ¨¡å¼
    timer = setTimeout(() => {
      isRepeating = true;
      updateScore(delta); // é€²å…¥é€£çºŒå‰å…ˆä¾†ä¸€æ¬¡
      timer = setInterval(() => updateScore(delta), 140);
    }, 300);
  };

  const stop = () => {
    const duration = performance.now() - downAt;

    if (isRepeating) {
      clearInterval(timer);
    } else {
      // çŸ­æŒ‰ï¼šåªåŸ·è¡Œä¸€æ¬¡
      if (duration < 300) updateScore(delta);
      clearTimeout(timer);
    }

    isRepeating = false;
    timer = null;
  };

  btn.addEventListener('pointerdown', start);
  btn.addEventListener('pointerup', stop);
  btn.addEventListener('pointercancel', stop);
  btn.addEventListener('pointerleave', stop);
}

bindPressRepeat(btnPlusCorner, +1);
bindPressRepeat(btnMinusCorner, -1);

/* â”€â”€ çµ„è£ï¼šå§“åä»åœ¨ç…§ç‰‡ä¸‹æ–¹ç½®ä¸­ï¼›ä¸å†å»ºç«‹èˆŠçš„ä¸‹æ–¹æ§åˆ¶åˆ— â”€â”€ */
info.appendChild(nameWrap);
seat.appendChild(photo);
seat.appendChild(info);
return seat;
}

function renderGrid(){
  const c=active(); if(!c) return;
  gridEl.innerHTML='';
  for(let r=1;r<=ROWS;r++) for(let col=1; col<=COLS; col++) gridEl.appendChild(seatCard(c,r,col));
}
function renderTabs(){
  tabsEl.innerHTML='';
  for(const c of state.classes){
    const b=document.createElement('button'); b.className='tab'+(c.id===state.activeId?' active':''); b.textContent=c.name;
    b.addEventListener('click', ()=> setActive(c.id)); tabsEl.appendChild(b);
  }
}

/* å°ºå¯¸æ»‘æ¡¿ */
function applyCellSize(px){ document.documentElement.style.setProperty('--cell', px + 'px'); sizeValue.textContent = px + 'px'; }
sizeRange.addEventListener('input', ()=>{ const v=Math.max(120,Math.min(200,+sizeRange.value||150)); state.settings.cell=v; scheduleSave(); applyCellSize(v); });

/* ========= è¨ˆæ™‚å™¨ ========= */
let tRunning = false, tBase = 0, tAccum = 0, tTick = null;

function fmt(n){ return String(n).padStart(2,'0'); }
function renderTimer(ms){
  const total = Math.max(0, Math.floor(ms/1000));
  const m = Math.floor(total/60), s = total%60;
  timerDisplay.textContent = `${fmt(m)}:${fmt(s)}`;
}

function startTimer(){
  if(tRunning) return;
  tRunning = true;
  tBase = performance.now();
  timerStartPause.textContent = 'æš«åœ';
  tTick = setInterval(()=> renderTimer(tAccum + (performance.now()-tBase)), 200);
}
function pauseTimer(){
  if(!tRunning) return;
  tRunning = false;
  tAccum += performance.now() - tBase;
  timerStartPause.textContent = 'é–‹å§‹';
  clearInterval(tTick); tTick = null;
  renderTimer(tAccum);
}
function resetTimer(){
  tRunning = false; tBase = 0; tAccum = 0;
  clearInterval(tTick); tTick = null;
  timerStartPause.textContent = 'é–‹å§‹';
  renderTimer(0);
}
function openTimer(){
  timerPanel.style.display = '';
  // ç½®ä¸­ä¸€æ¬¡ï¼ˆé¿å…è¦–çª—å°ºå¯¸æ”¹è®Šï¼‰
  timerPanel.style.left = '50%'; timerPanel.style.top = '50%';
  timerPanel.style.transform = 'translate(-50%,-50%)';
}

timerBtn?.addEventListener('click', ()=> openTimer());
timerStartPause?.addEventListener('click', ()=> tRunning ? pauseTimer() : startTimer());
timerReset?.addEventListener('click', resetTimer);
timerClose?.addEventListener('click', ()=>{ pauseTimer(); timerPanel.style.display='none'; });

/* å¯æ‹–æ›³ï¼šåªç”¨æ¨™é¡Œåˆ—æ‹–æ›³ */
(function enableDrag(){
  if(!timerPanel || !timerDragHandle) return;
  let sx=0, sy=0, ox=0, oy=0, dragging=false;

  function onDown(e){
    dragging = true;
    const rect = timerPanel.getBoundingClientRect();
    ox = rect.left; oy = rect.top;
    sx = e.clientX; sy = e.clientY;
    // æ‹–æ›³æ™‚å–æ¶ˆç½®ä¸­ transform
    timerPanel.style.transform = 'none';
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp, { once:true });
    e.preventDefault();
  }
  function onMove(e){
    if(!dragging) return;
    const nx = ox + (e.clientX - sx);
    const ny = oy + (e.clientY - sy);
    timerPanel.style.left = nx + 'px';
    timerPanel.style.top  = ny + 'px';
  }
  function onUp(){ dragging = false; document.removeEventListener('mousemove', onMove); }
  timerDragHandle.addEventListener('mousedown', onDown);
})();



/* æ–°å¢/æ”¹å/åˆªé™¤ç­ç´š */
document.getElementById('addClassBtn').addEventListener('click', ()=>{ 
  renameTargetId=null; 
  classDlgTitle.textContent='æ–°å¢ç­ç´š'; 
  classNameInput.value=''; 
  openDlg(classDlg); 
  classNameInput.focus(); 
});
document.getElementById('renameBtn').addEventListener('click', ()=>{ 
  const c=active(); if(!c) return; 
  renameTargetId=c.id; 
  classDlgTitle.textContent='é‡æ–°å‘½åç­ç´š'; 
  classNameInput.value=c.name; 
  openDlg(classDlg); 
  classNameInput.select(); 
});
document.getElementById('cancelClassBtn').addEventListener('click', ()=> closeDlg(classDlg));
classForm.addEventListener('submit', e=>{
  e.preventDefault();
  const name=(classNameInput.value||'æœªå‘½åç­ç´š').trim();
  if(renameTargetId){ 
    const t=state.classes.find(x=>x.id===renameTargetId); 
    if(t) t.name=name; 
    renameTargetId=null; 
  } else { 
    const nc=defaultClass(name); 
    state.classes.push(nc); 
    state.activeId=nc.id; 
  }
  scheduleSave(); renderTabs(); renderGrid(); closeDlg(classDlg);
});
document.getElementById('deleteClassBtn').addEventListener('click', ()=>{
  const c=active(); if(!c) return;
  deleteHint.textContent=`ç¢ºå®šè¦åˆªé™¤ã€Œ${c.name}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼ˆå»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ï¼‰ã€‚`;
  openDlg(deleteDlg);
});
document.getElementById('cancelDeleteBtn').addEventListener('click', ()=> closeDlg(deleteDlg));
document.getElementById('confirmDeleteBtn').addEventListener('click', ()=>{
  const id=active()?.id; closeDlg(deleteDlg); if(!id) return;
  state.classes = state.classes.filter(x=>x.id!==id);
  if(state.classes.length===0){ const nc=defaultClass(); state.classes.push(nc); state.activeId=nc.id; }
  else if(state.activeId===id){ state.activeId = state.classes[0].id; }
  scheduleSave(); renderTabs(); renderGrid();
});

/* æ‰‹å‹•åŠ å…¥åå†Šï¼ˆä¿ç•™åŸåŠŸèƒ½ï¼‰ */
document.getElementById('manualRosterBtn').addEventListener('click', ()=>{ 
  rosterText.value=''; overwriteChk.checked=true; clearMissingChk.checked=false; 
  openDlg(rosterDlg); rosterText.focus(); 
});
document.getElementById('cancelRosterBtn').addEventListener('click', ()=> closeDlg(rosterDlg));
function parseManualRoster(text){
  const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); const out=[];
  const isHeader=s=>/åº§è™Ÿ|å§“å|name|no|seat|number/i.test(s.replace(/\s/g,''));
  for(const line of lines){
    if(isHeader(line)) continue;
    const cleaned=line.replace(/[ï¼Œï¼›]/g, m => (m==='ï¼Œ' ? ',' : ';'));
    let parts=cleaned.split(/[;,]/);
    if(parts.length===1) parts=cleaned.split(/\t/);
    if(parts.length===1) parts=cleaned.trim().split(/\s+/);
    if(parts.length<2) continue;
    const no=parseInt(parts[0],10); 
    const name=parts.slice(1).join(' ').trim();
    if(Number.isFinite(no)&&no>=1&&no<=30&&name) out.push({no,name});
  }
  return out;
}
rosterForm.addEventListener('submit', e=>{
  e.preventDefault();
  const c=active(); if(!c){ alert('å°šæœªé¸æ“‡ç­ç´š'); return; }
  const rows=parseManualRoster(rosterText.value||''); 
  if(!rows.length){ alert('æ²’æœ‰å¯å¥—ç”¨çš„è³‡æ–™ã€‚è«‹ç¢ºèªæ¯è¡Œæ ¼å¼å¦‚ï¼š1 ç‹å°æ˜'); return; }
  const overwrite=overwriteChk.checked, clearMissing=clearMissingChk.checked; 
  const filledNo=new Set();
  for(const {no,name} of rows){
    const r=Math.ceil(no/10), col=((no-1)%10)+1; const k=seatKey(r,col);
    if(overwrite || !c.seats[k]?.name){ 
      const keepImg=c.seats[k]?.img||''; 
      c.seats[k]={name, img:keepImg}; 
    }
    filledNo.add(no);
  }
  if(clearMissing){ 
    for(let no=1; no<=30; no++){ 
      if(!filledNo.has(no)){ 
        const r=Math.ceil(no/10), col=((no-1)%10)+1; const k=seatKey(r,col); 
        if(c.seats[k]) c.seats[k].name=''; 
      }
    }
  }
  scheduleSave(); renderGrid(); closeDlg(rosterDlg); 
  alert(`å·²å¥—ç”¨ ${rows.length} ç­†åˆ°ã€Œ${c.name}ã€`);
});

/* ç…§ç‰‡ï¼šé»é¸/æ‹–æ”¾/è²¼ä¸Šï¼ˆå« Padlet èˆ‡ Drive é€£çµä¿®æ­£ï¼‰ */
let lastPhotoEl=null;
gridEl.addEventListener('click', e=>{
  const photo = e.target.closest('.photo'); if(!photo) return;
  lastPhotoEl = photo;
  const seat = photo.closest('.seat');
  const key = seat?.dataset.key;
  if(!key) return;
  fileProxyTargetKey = key;
  fileProxy.value = '';
  fileProxy.click();
});
fileProxy.addEventListener('change', async ()=>{
  const key = fileProxyTargetKey;
  fileProxyTargetKey = null;
  const c = active(); if(!c || !key) return;
  const data = c.seats[key] || {name:'', img:''};
  const file = fileProxy.files?.[0]; if(!file) return;
  data.img = await compressFile(file);
  c.seats[key] = data;
  scheduleSave(); renderGrid();
  fileProxy.value = '';
});
gridEl.addEventListener('dragover', e=>{ const p=e.target.closest('.photo'); if(!p) return; e.preventDefault(); p.classList.add('hover'); });
gridEl.addEventListener('dragleave', e=>{ const p=e.target.closest('.photo'); if(p) p.classList.remove('hover'); });
gridEl.addEventListener('drop', async e=>{
  const photo=e.target.closest('.photo'); if(!photo) return; e.preventDefault(); photo.classList.remove('hover'); lastPhotoEl=photo;
  const seat=photo.closest('.seat'); const key=seat?.dataset.key; const c=active(); if(!c||!key) return; const data=c.seats[key]||{name:'',img:''}; const dt=e.dataTransfer;
  const f=dt?.files&&dt.files[0];
  if(f){ data.img=await compressFile(f); c.seats[key]=data; scheduleSave(); renderGrid(); return; }
  const url=dt?.getData('text/uri-list')?.trim(); const html=dt?.getData('text/html'); const srcFromHtml=extractImgSrcFromHTML(html||''); const plain=dt?.getData('text/plain')?.trim();
  const pick=normalizeDriveImageURL(url||srcFromHtml||plain||'');
  if(pick && (isImageUrl(pick) || isDirectImageLink(pick) || isPadletAttachment(pick) || /^data:image\//i.test(pick))){
    if(/^data:image\//i.test(pick)) data.img=await compressDataURL(pick); else data.img=pick;
    c.seats[key]=data; scheduleSave(); renderGrid(); return;
  }
  alert('ç„¡æ³•è¾¨è­˜æ‹–æ”¾å…§å®¹ã€‚è«‹æ‹–ã€Œåœ–ç‰‡æª”ã€æˆ–è¤‡è£½åœ–ç‰‡ï¼åœ–ç‰‡ç¶²å€ã€‚');
});
document.addEventListener('paste', async e=>{
  const photo=lastPhotoEl||document.querySelector('.photo:hover'); if(!photo) return;
  const seat=photo.closest('.seat'); const key=seat?.dataset.key; const c=active(); if(!c||!key) return; const data=c.seats[key]||{name:'',img:''}; const cd=e.clipboardData;
  for(const item of cd.items){ 
    if(item.type && item.type.startsWith('image/')){ 
      const f=item.getAsFile(); 
      if(f){ data.img=await compressFile(f); c.seats[key]=data; scheduleSave(); renderGrid(); e.preventDefault(); return; } 
    } 
  }
  const txt=normalizeDriveImageURL(cd.getData('text/plain')?.trim()||'');
  if(txt && (isDirectImageLink(txt) || isPadletAttachment(txt) || /^data:image\//i.test(txt))){ 
    if(/^data:image\//i.test(txt)) data.img=await compressDataURL(txt); else data.img=txt; 
    c.seats[key]=data; scheduleSave(); renderGrid(); e.preventDefault(); 
  }
});

/* æŠ½é¸ */
document.getElementById('drawBtn').addEventListener('click', ()=>{ renderHistory(); rollNow.textContent='æº–å‚™ä¸­â€¦'; rollSub.textContent='æŒ‰ã€Œé–‹å§‹æŠ½ã€å•Ÿå‹•è·‘é¦¬ç‡ˆ'; confettiCanvas.style.display='none'; openDlg(drawDlg); });
document.getElementById('closeDrawBtn').addEventListener('click', ()=> closeDlg(drawDlg));
document.getElementById('resetDrawBtn').addEventListener('click', ()=>{ const c=active(); if(!c) return; c.draws={people:[],seats:[]}; scheduleSave(); renderHistory(); });
function renderHistory(){ const c=active(); if(!c) return; const wrap=document.getElementById('drawHistory'); const ppl=c.draws?.people||[]; const sts=c.draws?.seats||[]; wrap.innerHTML=`<div class="small" style="width:100%"><strong>æœ¬ç­æŠ½é¸ç´€éŒ„</strong><br>æŠ½äººï¼š${ppl.map(x=>`${x.no}.${x.name||'(æœªå¡«å§“å)'}`).join('ã€')||'â€”'}<br>æŠ½åº§ä½ï¼š${sts.map(x=>x.no).join('ã€')||'â€”'}</div>`; }
function getCandidates(){ const c=active(); if(!c) return []; const mode=document.querySelector('input[name="drawMode"]:checked').value; const skip=skipEmptySeat.checked; const arr=[]; for(let no=1;no<=30;no++){ const r=Math.ceil(no/10), col=((no-1)%10)+1, k=seatKey(r,col), d=c.seats[k]||{name:'',img:''}; if(mode==='person'){ if(d.name?.trim()) arr.push({no,name:d.name.trim(),key:k}); } else { if(skip? d.name?.trim(): true) arr.push({no,name:d.name?.trim()||'',key:k}); } } if(avoidRepeats.checked){ const drawn=(mode==='person'?(c.draws?.people||[]):(c.draws?.seats||[])).map(x=>x.no); return arr.filter(x=>!drawn.includes(x.no)); } return arr; }
let spinning=false;
document.getElementById('startDrawBtn').addEventListener('click', ()=>{
  if(spinning) return;
  const list=getCandidates();
  if(!list.length){ alert('ç›®å‰æ²’æœ‰å¯æŠ½çš„å°è±¡ã€‚'); return; }
  spinning=true; startDrawBtn.disabled=true;
  const duration=2800+Math.random()*800; const tStart=performance.now();
  let idx=Math.floor(Math.random()*list.length); let lastTick=tStart;
  const minI=40,maxI=140; const ease=x=>1-Math.pow(1-x,3);
  function step(t){
    const p=Math.min(1,(t-tStart)/duration);
    const interval=minI+(maxI-minI)*ease(p);
    if(t-lastTick>=interval){
      lastTick=t; idx=(idx+1)%list.length;
      const it=list[idx];
      rollNow.textContent=it.name?`${it.no}. ${it.name}`:`åº§ä½ ${it.no}`;
      rollSub.textContent=`å€™é¸æ•¸ï¼š${list.length}ï¼ˆ${avoidRepeats.checked?'é¿å…é‡è¤‡':'å¯é‡è¤‡'}ï¼‰`;
    }
    if(p<1) requestAnimationFrame(step);
    else { finalizePick(list[idx]); spinning=false; startDrawBtn.disabled=false; }
  }
  requestAnimationFrame(step);
});
function finalizePick(item){ 
  const c=active(); if(!c) return; 
  const mode=document.querySelector('input[name="drawMode"]:checked').value; 
  if(mode==='person') c.draws.people.push({no:item.no,name:item.name}); 
  else c.draws.seats.push({no:item.no,name:item.name}); 
  scheduleSave(); renderHistory(); 
  const r=Math.ceil(item.no/10), col=((item.no-1)%10)+1, k=seatKey(r,col), el=gridEl.querySelector(`.seat[data-key="${k}"]`); 
  if(el){ el.classList.add('flash'); el.scrollIntoView({behavior:'smooth',block:'center',inline:'center'}); setTimeout(()=>el.classList.remove('flash'),1200); } 
  runConfetti(); 
}
function runConfetti(){ 
  const cv=confettiCanvas; cv.style.display='block'; const ctx=cv.getContext('2d'); 
  const W=cv.width=cv.clientWidth; const H=cv.height=cv.clientHeight; 
  const N=120; const parts=Array.from({length:N},()=>({x:Math.random()*W,y:-10-Math.random()*H*0.3,vx:(Math.random()-0.5)*2,vy:2+Math.random()*3,w:6+Math.random()*6,h:8+Math.random()*10,r:Math.random()*Math.PI,vr:(Math.random()-0.5)*0.2,a:0.7+Math.random()*0.3}));
  let t0=performance.now(); const stop=t0+1800;
  function step(t){ 
    const dt=Math.min(32,t-t0); t0=t; ctx.clearRect(0,0,W,H);
    for(const p of parts){ 
      p.x+=p.vx*dt/16; p.y+=p.vy*dt/16; p.r+=p.vr*dt/16; 
      if(p.y>H+20){ p.y=-10; p.x=Math.random()*W; } 
      ctx.save(); ctx.globalAlpha=p.a; ctx.translate(p.x,p.y); ctx.rotate(p.r); 
      ctx.fillStyle=`hsl(${(p.x/W)*360},90%,55%)`; 
      ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); 
      ctx.restore(); 
    }
    if(t<stop) requestAnimationFrame(step); else cv.style.display='none';
  } 
  requestAnimationFrame(step);
}

/* åŒ¯å‡º/åŒ¯å…¥/åˆ—å° */
document.getElementById('backupBtn').addEventListener('click', ()=>{ 
  const blob=new Blob([JSON.stringify(state)],{type:'application/json'}); 
  const url=URL.createObjectURL(blob); 
  const a=document.createElement('a'); a.href=url; a.download='seating-3x10-backup.json'; a.click(); 
  setTimeout(()=>URL.revokeObjectURL(url),400); 
});
document.getElementById('restoreInput').addEventListener('change', async e=>{
  const f=e.target.files?.[0]; if(!f) return; 
  try{ 
    const txt=await f.text(); 
    const data=JSON.parse(txt); 
    if(data&&data.classes){ 
      data.classes.forEach(c=>{ if(!c.draws) c.draws={people:[],seats:[]}; }); 
      state=data; if(!state.settings) state.settings={cell:150}; 
      scheduleSave(); renderTabs(); renderGrid(); 
      applyCellSize(state.settings.cell||150); sizeRange.value=state.settings.cell||150; 
      setStatus('å·²å¾å‚™ä»½è¼‰å…¥ï¼ˆè‹¥å·²é€£çµè³‡æ–™æª”æœƒè‡ªå‹•å¯«å›ï¼‰','ok'); 
    } else alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º'); 
  }catch(err){ alert('åŒ¯å…¥å¤±æ•—ï¼š'+err.message); }
});
document.getElementById('printBtn').addEventListener('click', ()=> window.print());

/* å¯æ”œå¼å°ˆæ¡ˆæª” */
async function linkExistingFile(){
  if(!supportsFSA || document.documentElement.classList.contains('embedded')){ alert('æ­¤ç’°å¢ƒä¸æ”¯æ´æª”æ¡ˆå­˜å– APIï¼ˆSites/åµŒå…¥å¤šåŠè¢«é™åˆ¶ï¼‰ã€‚'); return; }
  try{
    const [h]=await showOpenFilePicker({types:[{description:'Seating JSON',accept:{'application/json':['.json']}}],excludeAcceptAllOption:false,multiple:false});
    projectHandle=h; await idbSet('projectHandle',h); unlinkFileBtn.disabled=false;
    await loadFromFile(); await persistToFile();
    if(navigator.storage?.persist) navigator.storage.persist();
  }catch(err){ if(err?.name!=='AbortError') setStatus('é¸æ“‡è³‡æ–™æª”å–æ¶ˆæˆ–å¤±æ•—','bad'); }
}
async function createNewFile(){
  if(!supportsFSA || document.documentElement.classList.contains('embedded')){ alert('æ­¤ç’°å¢ƒä¸æ”¯æ´æª”æ¡ˆå­˜å– APIï¼ˆSites/åµŒå…¥å¤šåŠè¢«é™åˆ¶ï¼‰ã€‚'); return; }
  try{
    const h=await showSaveFilePicker({suggestedName:'seating-data.json',types:[{description:'Seating JSON',accept:{'application/json':['.json']}}]});
    projectHandle=h; await idbSet('projectHandle',h); unlinkFileBtn.disabled=false;
    lastFileName=(await h.getFile()).name;
    await persistToFile();
    setStatus(`å·²å»ºç«‹ä¸¦ä¿å­˜ï¼š${lastFileName}`,'ok');
    if(navigator.storage?.persist) navigator.storage.persist();
  }catch(err){ if(err?.name!=='AbortError') setStatus('å»ºç«‹è³‡æ–™æª”å–æ¶ˆæˆ–å¤±æ•—','bad'); }
}
async function unlinkFile(){ projectHandle=null; lastFileName=''; await idbDel('projectHandle'); unlinkFileBtn.disabled=true; setStatus('æœªé€£çµè³‡æ–™æª”ï¼ˆä½¿ç”¨æœ¬æ©Ÿå„²å­˜ï¼‰','warn'); }
document.getElementById('linkFileBtn').addEventListener('click', linkExistingFile);
document.getElementById('createFileBtn').addEventListener('click', createNewFile);
document.getElementById('unlinkFileBtn').addEventListener('click', unlinkFile);

/* ========= è¨­å®šé¢æ¿ï¼ˆå«é è¦½/å‹¾é¸åŒ¯å…¥ï¼‰ ========= */
function extractSpreadsheetId(s){
  const m = s.match(/spreadsheets\/d\/([a-zA-Z0-9\-_]+)/);
  if (m && m[1]) return m[1];
  if (/^[a-zA-Z0-9\-_]+$/.test(s)) return s;
  const q = s.match(/[?&]id=([a-zA-Z0-9\-_]+)/);
  if (q && q[1]) return q[1];
  return '';
}
openSettingsBtn.addEventListener('click', ()=>{
  gasUrlInput.value = getGasUrl();
  sheetIdInput.value = getSheetId();
  includePhotosChk.checked = true;
  testResult.textContent = '';
  renderPreview(lastPreview); 
  openDlg(settingsDlg);
});
document.getElementById('cancelSettingsBtn').addEventListener('click', ()=> closeDlg(settingsDlg));
settingsForm.addEventListener('submit', e=>{
  e.preventDefault();
  const url = gasUrlInput.value.trim();
  const raw = sheetIdInput.value.trim();
  if(!url || !raw){ alert('è«‹å¡«å¯«å®Œæ•´è¨­å®š'); return; }
  const ssId = extractSpreadsheetId(raw);
  if(!ssId){ alert('ç„¡æ³•è§£æè©¦ç®—è¡¨ IDï¼Œè«‹ç¢ºèªã€‚'); return; }
  setGasUrl(url); setSheetId(ssId);
  setStatus('è¨­å®šå·²å„²å­˜', 'ok');
  alert('è¨­å®šå·²å„²å­˜ã€‚ä½ å¯æŒ‰ã€Œæ¸¬è©¦é€£ç·šä¸¦é è¦½ã€ç¢ºèªç­ç´šæ¸…å–®ï¼Œæˆ–é—œé–‰è¨­å®šã€‚');
});

async function fetchPreview(){
  const url = gasUrlInput.value.trim();
  const raw = sheetIdInput.value.trim();
  if(!url || !raw){ throw new Error('è«‹å…ˆå¡«å¥½ GAS URL èˆ‡è©¦ç®—è¡¨'); }
  const ssId = extractSpreadsheetId(raw);
  if(!ssId){ throw new Error('ç„¡æ³•è§£æè©¦ç®—è¡¨ ID'); }
  const photos = includePhotosChk.checked ? '1' : '0';
  const api = url + '?spreadsheetId=' + encodeURIComponent(ssId) + '&photos=' + photos;
  const res = await fetch(api);
  const data = await res.json();
  if(!data.success) throw new Error(data.error || 'GAS å›å‚³å¤±æ•—');
  return data;
}
testFetchBtn.addEventListener('click', async ()=>{
  testResult.textContent = 'æ¸¬è©¦ä¸­â€¦';
  try{
    const data = await fetchPreview();
    testResult.textContent = `OKï¼åµæ¸¬åˆ° ${data.classes?.length||0} å€‹ç­ç´šã€‚`;
    lastPreview = { classes: data.classes||[] };
    savePreview(lastPreview);
    renderPreview(lastPreview);
  }catch(err){
    testResult.textContent = 'å¤±æ•—ï¼š' + err.message;
    renderPreview(null);
  }
});
function renderPreview(preview){
  if(!preview || !Array.isArray(preview.classes) || !preview.classes.length){
    previewWrap.style.display = 'none';
    previewList.innerHTML = '';
    previewHint.textContent = '';
    return;
  }
  previewWrap.style.display = '';
  const rows = preview.classes.map((c,idx)=>{
    const rosterCnt = Array.isArray(c.roster) ? c.roster.length : 0;
    const photoCnt = c.photos ? Object.keys(c.photos).length : 0;
    return `
      <div class="previewRow" role="listitem" data-idx="${idx}">
        <div><input type="checkbox" class="pvChk" checked aria-label="é¸å–"></div>
        <div><strong>${escapeHtml(c.className||'æœªå‘½åç­ç´š')}</strong><br><small>D2:D31 åå†Šï¼›E2 è³‡æ–™å¤¾ï¼š${c.folderUsed? 'âœ”ï¸' : 'â€”'}</small></div>
        <div>åå†Šï¼š<strong>${rosterCnt}</strong> ç­†</div>
        <div>ç…§ç‰‡ï¼š<strong>${photoCnt}</strong> å¼µ</div>
      </div>`;
  }).join('');
  previewList.innerHTML = rows;
  previewHint.textContent = 'æç¤ºï¼šæœªå¡« E2 ä¹Ÿèƒ½åŒ¯å…¥åå†Šï¼ˆç…§ç‰‡ç•¥éï¼‰ã€‚';
}
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;', '"':'&quot;', "'":'&#39;' }[m])); }
selectAllBtn.addEventListener('click', ()=> previewList.querySelectorAll('.pvChk').forEach(c=>c.checked=true));
selectNoneBtn.addEventListener('click', ()=> previewList.querySelectorAll('.pvChk').forEach(c=>c.checked=false));
importSelectedBtn.addEventListener('click', ()=>{
  if(!lastPreview || !Array.isArray(lastPreview.classes) || !lastPreview.classes.length){ alert('è«‹å…ˆæ¸¬è©¦é€£ç·šä¸¦å–å¾—é è¦½'); return; }
  const chks = [...previewList.querySelectorAll('.pvChk')];
  const sel = chks.map((chk,i)=> chk.checked ? lastPreview.classes[i] : null ).filter(Boolean);
  if(!sel.length){ alert('å°šæœªé¸å–ç­ç´š'); return; }
  applyGasImport(sel);
  setStatus('åŒ¯å…¥å®Œæˆï¼š' + sel.length + ' å€‹ç­ç´š', 'ok');
  alert('å·²åŒ¯å…¥ ' + sel.length + ' å€‹ç­ç´šã€‚ä½ å¯é—œé–‰è¨­å®šè¦–çª—é–‹å§‹ä½¿ç”¨ã€‚');
});

/* å¾è©¦ç®—è¡¨åŒ¯å…¥ï¼ˆGASï¼‰- å¿«æ·ï¼šå…¨éƒ¨åŒ¯å…¥ */
document.getElementById('importGasBtn').addEventListener('click', async ()=>{
  const gasUrl = getGasUrl();
  const ssId  = getSheetId();
  if(!gasUrl || !ssId){
    alert('è«‹å…ˆåœ¨ã€Œâš™ï¸ è¨­å®šã€å¡«å…¥ GAS URL èˆ‡è©¦ç®—è¡¨ IDï¼Œä¸¦æŒ‰ã€Œæ¸¬è©¦é€£ç·šä¸¦é è¦½ã€ã€‚');
    openSettingsBtn.click();
    return;
  }
  setStatus('åŒ¯å…¥ä¸­â€¦', 'warn');
  try{
    const photos = includePhotosChk.checked ? '1' : '0';
    const api = gasUrl + '?spreadsheetId=' + encodeURIComponent(ssId) + '&photos=' + photos;
    const res = await fetch(api);
    const data = await res.json();
    if (!data.success) throw new Error(data.error || 'GAS å›å‚³å¤±æ•—');
    applyGasImport(data.classes);
    lastPreview = { classes: data.classes||[] };
    savePreview(lastPreview);
    renderPreview(lastPreview);
    setStatus('åŒ¯å…¥å®Œæˆï¼š' + (data.classes?.length || 0) + ' å€‹ç­ç´š', 'ok');
  }catch(err){
    setStatus('åŒ¯å…¥å¤±æ•—ï¼š' + err.message, 'bad');
    alert('åŒ¯å…¥å¤±æ•—ï¼š' + err.message + '\nè«‹æª¢æŸ¥ï¼š\n1) GAS æ˜¯å¦éƒ¨ç½²ç‚ºä»»ä½•äººå¯å­˜å–\n2) è©¦ç®—è¡¨èˆ‡è³‡æ–™å¤¾æ¬Šé™\n3) URL/ID æ˜¯å¦æ­£ç¢º');
  }
});
function applyGasImport(classes){
  if (!Array.isArray(classes)) return;
  for (const cls of classes) {
    const name = cls.className || 'æœªå‘½åç­ç´š';
    let c = state.classes.find(x => x.name === name);
    if (!c) { c = defaultClass(name); state.classes.push(c); }
    c.draws = { people:[], seats:[] };
    for (let no=1; no<=30; no++){
      const r=Math.ceil(no/10), col=((no-1)%10)+1; const k=seatKey(r,col);
      if (!c.seats[k]) c.seats[k]={name:'',img:''};
      c.seats[k].name='';
    }
    if (Array.isArray(cls.roster)) {
      for (const row of cls.roster) {
        const no = row.no|0; const nm = (row.name||'').trim();
        if (no>=1 && no<=30 && nm) {
          const r=Math.ceil(no/10), col=((no-1)%10)+1; const k=seatKey(r,col);
          const keepImg = c.seats[k]?.img || '';
          c.seats[k] = { name: nm, img: keepImg };
        }
      }
    }
    if (cls.photos && typeof cls.photos === 'object' && Object.keys(cls.photos).length){
      for (let no=1; no<=30; no++){
        const url = cls.photos[String(no)];
        if (url) {
          const r=Math.ceil(no/10), col=((no-1)%10)+1; const k=seatKey(r,col);
          const keepName = c.seats[k]?.name || '';
          c.seats[k] = { name: keepName, img: normalizeDriveImageURL(url) };
        }
      }
    }
  }
  if (classes.length) {
    const firstName = classes[0].className || state.classes[0].name;
    const target = state.classes.find(x=>x.name===firstName) || state.classes[0];
    state.activeId = target.id;
  }
  scheduleSave(); renderTabs(); renderGrid();
}

/* å•Ÿå‹• */
(function init(){
  sizeRange.value = state.settings.cell || 150; applyCellSize(state.settings.cell || 150);
  renderTabs(); renderGrid();

  if (document.documentElement.classList.contains('embedded')) {
    setStatus('åµŒå…¥æ¨¡å¼ï¼šä½¿ç”¨æœ¬æ©Ÿå„²å­˜','warn');
    unlinkFileBtn.disabled = true;
  } else if(!supportsFSA){
    setStatus('æ­¤ç€è¦½å™¨ä¸æ”¯æ´æª”æ¡ˆå­˜å– APIï¼ˆä½¿ç”¨æœ¬æ©Ÿå„²å­˜ï¼‰','bad');
  } else {
    idbGet('projectHandle').then(async h=>{
      if(h){ projectHandle=h; try{ await loadFromFile(); }catch(e){ } }
      else { setStatus('æœªé€£çµè³‡æ–™æª”ï¼ˆä½¿ç”¨æœ¬æ©Ÿå„²å­˜ï¼‰','warn'); }
    });
  }

  // Settings é å¡«èˆ‡ä¸Šæ¬¡é è¦½
  gasUrlInput.value = getGasUrl();
  sheetIdInput.value = getSheetId();
  renderPreview(lastPreview);

  // åµŒå…¥æ™‚è‡ªé©æ‡‰æ¯è¡Œ 10 åº§ä½
  if (document.documentElement.classList.contains('embedded')) {
    const gap=10; const ro=new ResizeObserver(entries=>{
      for(const entry of entries){
        const w=entry.contentBoxSize?(entry.contentBoxSize[0]?.inlineSize||entry.contentRect.width):entry.contentRect.width;
        if(!w) continue; const safe=Math.max(0,w-2); const cell=Math.floor((safe-gap*9)/10);
        const clamped=Math.max(120,Math.min(200,cell)); document.documentElement.style.setProperty('--cell',clamped+'px'); sizeRange.value=clamped; sizeValue.textContent=clamped+'px';
      }
    }); ro.observe(gridEl);
  }
})();
</script>
<!-- === æŠ½ç±¤å¢å¼· v2.2ï¼šç§»é™¤èˆŠæŠ½é¸éˆ•+åˆ—å°é‡æ’ + éŸ³æ•ˆé è¨­Fanfare + ç½®ä¸­ç´€éŒ„é¢æ¿(å«æ¸…é™¤) === -->
<style>
  .mini-draw-bar{position:sticky;top:52px;z-index:99;background:#fff;border-bottom:1px dashed var(--line);padding:.5rem .8rem;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
  .mini-draw-bar .badge{display:inline-flex;align-items:center;gap:.35rem;border:1px solid var(--line);border-radius:999px;padding:.25rem .6rem;background:#fff;white-space:nowrap;font-size:.9rem}
  .mini-draw-bar .btn{padding:.4rem .7rem;border:1px solid var(--line);background:#fff;border-radius:10px;cursor:pointer}
  .mini-draw-bar .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .mini-draw-bar .result{font-weight:600}
  .mini-draw-bar .muted{color:var(--muted);font-size:.9rem}
  .mini-draw-bar select{border:1px solid var(--line);border-radius:8px;padding:.25rem .4rem;background:#fff}
  @media (max-width:640px){ .mini-draw-bar{top:48px} }

  /* è·‘é¦¬ç‡ˆ */
  .seat._rolling{ outline:3px solid #60a5fa; box-shadow:0 0 0 4px rgba(96,165,250,.22) inset, 0 2px 10px rgba(0,0,0,.12); transform:scale(1.08); transition:transform .08s ease, outline-color .08s ease, box-shadow .08s ease; will-change:transform,box-shadow }
  /* åœä½ï¼šæ”¾å¤§1.14 + ç„¡é™è„ˆè¡ */
  .seat._final{ outline:3px solid #22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.22) inset, 0 0 26px rgba(34,197,94,.45); transform:scale(1.14); transition:transform .22s ease, box-shadow .22s ease, outline-color .22s ease }
  @keyframes ringPulseBig{0%{box-shadow:0 0 0 0 rgba(34,197,94,.6),0 0 0 4px rgba(34,197,94,.22) inset}70%{box-shadow:0 0 0 20px rgba(34,197,94,0),0 0 0 4px rgba(34,197,94,.22) inset}100%{box-shadow:0 0 0 0 rgba(34,197,94,0),0 0 0 4px rgba(34,197,94,.22) inset}}
  .seat._winner-pulse{ animation:ringPulseBig .9s ease-out infinite }

  /* å½©å¸¶ï¼ˆè¦†è“‹ç…§ç‰‡å€ï¼‰ */
  .seat._celebrate{ position:relative }
  .seat .confetti{ position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; overflow:visible }
  .seat .confetti-piece{ position:absolute; width:7px; height:14px; border-radius:2px; opacity:1; transform:translate(0,0) rotate(0deg); animation:confFall var(--dur,0.9s) ease-out forwards }
  @keyframes confFall{ 100%{ transform:translate(var(--dx),var(--dy)) rotate(var(--rz)); opacity:0 } }

  /* æŠ½é¸ç´€éŒ„ï¼šç½®ä¸­æ¨¡æ…‹ + é®ç½© + å‹•ä½œåˆ— */
  .mini-mask{ position:fixed; inset:0; background:rgba(0,0,0,.25); z-index:998 }
  .mini-history{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:min(560px,92vw); max-height:72vh; overflow:auto; background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:0 18px 36px rgba(0,0,0,.16); z-index:999 }
  .mini-history header{ display:flex; justify-content:space-between; align-items:center; gap:.6rem; padding:.6rem .8rem; border-bottom:1px solid var(--line); position:sticky; top:0; background:#fff }
  .mini-history .title{ font-weight:700 }
  .mini-history .actions{ display:flex; gap:.5rem }
  .mini-history .actions .btn{ padding:.35rem .6rem; border:1px solid var(--line); border-radius:8px; background:#fff; cursor:pointer }
  .mini-history .actions .danger{ background:#fee2e2; border-color:#fecaca }
  .mini-history .body{ padding:.6rem .8rem }
  .mini-history table{ width:100%; border-collapse:collapse; font-size:.95rem }
  .mini-history th,.mini-history td{ border-bottom:1px dashed var(--line); padding:.35rem .4rem; text-align:left; white-space:nowrap }
  .mini-history .muted{ color:var(--muted) }

/* === æ–¹æ¡ˆAï¼šç…§ç‰‡ç–ŠåŠ å‹ === */
.seat .photo{ position: relative; }
.no-badge{
  position:absolute; left:8px; top:8px;
  width:28px; height:28px; border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  background:#ffffff; border:1px solid var(--line); box-shadow:0 2px 6px rgba(0,0,0,.08);
  font:700 0.9rem/1 ui-monospace,Menlo,monospace; color:#111827;
}
.score-pill{
  position:absolute; right:8px; top:8px;
  min-width:44px; height:28px; padding:0 .5rem; border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  background:#f3f4f6; border:1px solid var(--line); box-shadow:0 2px 6px rgba(0,0,0,.08);
  font:700 0.9rem/1 ui-monospace,Menlo,monospace; color:#111827;
}
.score-pill.pos{ background:#e8f7ee; border-color:#b7e3c8; }
.score-pill.neg{ background:#fdeaea; border-color:#f3c2c2; }

.seat .info .no{ display:none; }            /* éš±è—åŸä¾†ç…§ç‰‡ä¸‹æ–¹çš„åº§è™Ÿåˆ— */
.name .text{
  max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.score-ctl-row{
  display:flex; justify-content:center; gap:.5rem; margin-top:.4rem;
}
.score-ctl-row .mini{
  width:36px; height:36px; padding:0; border-radius:10px;
  border:1px solid var(--line); background:#fff; cursor:pointer;
}
.score-ctl-row .mini:active{ transform: translateY(1px); }


</style>

<script>
(function(){
  /* ---------- ç§»é™¤èˆŠç²¾ç°¡æ¢èˆ‡æŠ½ç±¤é¢æ¿ ---------- */
  document.querySelectorAll('.mini-draw-bar').forEach(el=>el.remove());
  const killOldPanel = ()=>{
    let p = document.querySelector('#drawPanel, .draw-panel, .drawModal, .drawer, .panel-draw, .modal');
    const startBtn = document.getElementById('startDrawBtn');
    if(!p && startBtn){
      let cur=startBtn; for(let i=0;i<5 && cur;i++){ if(cur.classList && (cur.classList.contains('modal')||cur.classList.contains('panel')||cur.id==='drawPanel')){ p=cur; break; } cur=cur.parentElement; }
    }
    if(p) p.remove();
  };
  setTimeout(killOldPanel, 0);

  const gridEl = document.getElementById('grid'); if(!gridEl) return;
  const headerRow = document.querySelector('header .bar .row') || document.querySelector('header .bar') || document.querySelector('header');

  /* ---------- èˆ‡ä¸»ç¨‹å¼éŠœæ¥ ---------- */
  const ROWS = window.ROWS || 3, COLS = window.COLS || 10;
  const seatKey = (r,c)=> (typeof window.seatKey==='function'? window.seatKey(r,c) : `R${r}-C${c}`);
  const getActive = ()=> (typeof window.active==='function'? window.active() : null);
  const scheduleSave = window.scheduleSave || function(){};
  const renderHistory = window.renderHistory || function(){};

  const $ = s=>document.querySelector(s);
  const sleep = ms => new Promise(r=>setTimeout(r, ms));
  const shuffle = a => {for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1)|0); [a[i],a[j]]=[a[j],a[i]];} return a;};
  const mod = (x,m)=>((x%m)+m)%m;

  /* ---------- æ–°ç‰ˆç²¾ç°¡æ¢ ---------- */
  const bar = document.createElement('div');
  bar.className='mini-draw-bar';
  bar.innerHTML = `
    <label class="badge"><input type="radio" name="miniMode" value="person" checked> æŠ½äºº</label>
    <label class="badge"><input type="radio" name="miniMode" value="seat"> æŠ½åº§ä½</label>
    <label class="badge"><input id="miniSkip" type="checkbox" checked> ç•¥éç©ºä½</label>
    <label class="badge"><input id="miniAvoid" type="checkbox" checked> é¿å…é‡è¤‡</label>
    <label class="badge"><input id="miniSound" type="checkbox" checked> è²éŸ³</label>
    <label class="badge">éŸ³æ•ˆé¢¨æ ¼
      <select id="miniSoundStyle">
        <option value="cheer">æ­¡å‘¼ï¼ˆCheerï¼‰</option>
        <option value="fanfare">å‹åˆ©ï¼ˆFanfareï¼‰</option>
        <option value="chime">æ¸…è„†ï¼ˆChimeï¼‰</option>
        <option value="levelup">å‡ç´šï¼ˆLevel-upï¼‰</option>
        <option value="tada">Ta-da</option>
      </select>
    </label>
    <button id="miniStart" class="btn primary" type="button" title="éš¨æ©ŸæŠ½é¸">ğŸ² éš¨æ©ŸæŠ½é¸</button>
    <button id="miniHistoryBtn" class="btn" type="button">æŠ½é¸ç´€éŒ„</button>
    <button id="miniExport" class="btn" type="button">åŒ¯å‡ºæœ¬ç­æŠ½é¸ç´€éŒ„ï¼ˆCSVï¼‰</button>
    <span class="muted">çµæœï¼š</span>
    <span id="miniResult" class="result">â€”</span>
  `;
  if(headerRow) headerRow.parentElement.insertAdjacentElement('afterend', bar); else document.body.prepend(bar);

  const miniStart = $('#miniStart'), miniExport=$('#miniExport'), miniResult=$('#miniResult');
  const miniHistoryBtn=$('#miniHistoryBtn'), miniStyleSel=$('#miniSoundStyle');

  /* ---------- éŸ³æ•ˆï¼ˆé è¨­ï¼šfanfareï¼‰ ---------- */
  const AC = window.AudioContext || window.webkitAudioContext;
  const audio = AC ? new AC() : null;
  const soundOn = ()=> document.getElementById('miniSound')?.checked ?? true;
  const SOUND_KEY='seating.sound.style.v1';
  try{
    const saved = localStorage.getItem(SOUND_KEY);
    const value = ['cheer','fanfare','chime','levelup','tada'].includes(saved) ? saved : 'fanfare';
    miniStyleSel.value = value;
    if(!saved) localStorage.setItem(SOUND_KEY, value);
  }catch{}
  miniStyleSel.addEventListener('change', ()=>{ try{ localStorage.setItem(SOUND_KEY, miniStyleSel.value); }catch{} });

  function tone(f, t0, dur=0.6, type='sine', gain=0.08){ if(!audio) return;
    const o=audio.createOscillator(), g=audio.createGain(); o.type=type; o.frequency.setValueAtTime(f, t0);
    g.gain.setValueAtTime(gain, t0); g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
    o.connect(g).connect(audio.destination); o.start(t0); o.stop(t0+dur);
  }
  function whiteNoise(len=0.25, gain=0.03, hpFreq){ if(!audio) return null;
    const sr=audio.sampleRate, buf=audio.createBuffer(1, Math.floor(sr*len), sr), data=buf.getChannelData(0);
    for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*(1-i/data.length);
    const src=audio.createBufferSource(); src.buffer=buf; let node=src;
    if(hpFreq){ const hp=audio.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=hpFreq; hp.Q.value=0.9; node.connect(hp); node=hp; }
    const g=audio.createGain(); g.gain.value=gain; node.connect(g).connect(audio.destination);
    return {src, g};
  }
  function playClick(){ if(!audio) return; const now=audio.currentTime, o=audio.createOscillator(), g=audio.createGain();
    const p=720*(0.9+Math.random()*0.2); o.type='square'; o.frequency.value=p; g.gain.value=0.040*(0.85+Math.random()*0.3);
    o.connect(g).connect(audio.destination); o.start(now); o.stop(now+0.03);
    if(Math.random()<0.11){ const o2=audio.createOscillator(), g2=audio.createGain(); o2.type='square'; o2.frequency.value=p*1.06; g2.gain.value=0.028; o2.connect(g2).connect(audio.destination); o2.start(now+0.045); o2.stop(now+0.075); }
  }
  function playFanfare(){ if(!audio) return; const t=audio.currentTime;
    const seq=[523.25,783.99,1174.66,1046.5];
    seq.forEach((f,i)=>{ tone(f, t+i*0.14, 0.7, 'sawtooth', 0.12); tone(f*0.5, t+i*0.14, 0.7, 'triangle', 0.10); tone(f*1.01, t+i*0.14, 0.7, 'sawtooth', 0.05); });
    [523.25,659.25,783.99].forEach(f=> tone(f, t+0.05, 0.85, 'sine', 0.07));
    const cym=whiteNoise(0.5,0.04,1800); if(cym){ const tt=t+0.16; cym.src.start(tt); cym.src.stop(tt+0.5); }
  }
  function playCheer(){ if(!audio) return; const t=audio.currentTime;
    const len=1.4, sr=audio.sampleRate, buf=audio.createBuffer(1, Math.floor(sr*len), sr), d=buf.getChannelData(0);
    for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
    const bed=audio.createBufferSource(); bed.buffer=buf;
    const bp=audio.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1200; bp.Q.value=0.8;
    const g=audio.createGain(); g.gain.setValueAtTime(0.0001, t); g.gain.exponentialRampToValueAtTime(0.14, t+0.05); g.gain.exponentialRampToValueAtTime(0.0001, t+1.3);
    bed.connect(bp).connect(g).connect(audio.destination); bed.start(t); bed.stop(t+1.35);
    for(let i=0;i<16;i++){ const n=whiteNoise(0.12,0.05+Math.random()*0.05,1800); if(n){ const tt=t+0.10+Math.random()*0.7; n.src.start(tt); n.src.stop(tt+0.12); } }
    [1760,1975.53,2093].forEach((f,i)=> tone(f*0.96, t+0.35+i*0.1, 0.55, 'sine', 0.06));
    const cym=whiteNoise(0.35,0.035,2200); if(cym){ cym.src.start(t+0.18); cym.src.stop(t+0.5); }
  }
  function playChime(){ const t=audio.currentTime, base=659.25; [0,3,7,12].forEach((st,i)=> tone(base*Math.pow(2,st/12), t+i*0.08, 0.7, 'sine', 0.08)); tone(987.77, t+0.28, 0.6, 'triangle', 0.06); }
  function playLevelup(){ const t=audio.currentTime, base=523.25; for(let i=0;i<6;i++) tone(base*Math.pow(2,i/12), t+i*0.07, 0.35, 'square', 0.06); tone(783.99, t+0.44, 0.45, 'sawtooth', 0.07); }
  function playTada(){ const t=audio.currentTime; tone(659.25, t, 0.5, 'triangle', 0.09); tone(523.25, t+0.18, 0.7, 'sawtooth', 0.10); const n=whiteNoise(0.2,0.035,1600); if(n){ n.src.start(t+0.12); n.src.stop(t+0.32); } }
  function playWin(){ if(!audio || !soundOn()) return; if(audio.state==='suspended' && audio.resume) audio.resume(); ({cheer:playCheer,fanfare:playFanfare,chime:playChime,levelup:playLevelup,tada:playTada}[miniStyleSel?.value||'fanfare']||playFanfare)(); }

  /* ---------- å€™é¸ã€è¦–è¦ºã€å½©å¸¶ ---------- */
  function getCandidates(mode, skipEmpty, avoidRepeats){
    const c=getActive(); if(!c) return [];
    const list=[];
    for(let r=1;r<=ROWS;r++){ for(let col=1; col<=COLS; col++){
      const key=seatKey(r,col), data=c.seats?.[key]||{}, name=(data.name||'').trim(), no=(r-1)*COLS+col;
      if(skipEmpty && !name) continue; list.push({no,name,key});
    }}
    if(avoidRepeats){ const drawn=(mode==='person'?(c.draws?.people||[]):(c.draws?.seats||[])).map(x=>x.no); return list.filter(x=>!drawn.includes(x.no)); }
    return list;
  }
  function clearRolling(){ gridEl.querySelectorAll('._rolling').forEach(el=>el.classList.remove('_rolling')); }
  function clearFinal(){ gridEl.querySelectorAll('._final').forEach(el=>el.classList.remove('_final','_winner-pulse','_celebrate')); gridEl.querySelectorAll('.confetti').forEach(el=>el.remove()); }
  function launchConfettiOnSeat(seat,bursts=3,per=36){
    seat.classList.add('_celebrate');
    const pic=seat.querySelector('.photo,.image,.avatar,img')||seat, sRect=seat.getBoundingClientRect(), pRect=pic.getBoundingClientRect();
    const layer=document.createElement('div'); layer.className='confetti';
    layer.style.left=(pRect.left-sRect.left)+'px'; layer.style.top=(pRect.top-sRect.top)+'px'; layer.style.width=pRect.width+'px'; layer.style.height=pRect.height+'px';
    seat.appendChild(layer);
    const colors=['#ef4444','#f59e0b','#10b981','#3b82f6','#8b5cf6','#ec4899','#22c55e','#eab308'];
    let count=0; const fire=()=>{ for(let i=0;i<per;i++){ const d=document.createElement('div'); d.className='confetti-piece';
      const w=6+Math.random()*4,h=10+Math.random()*8; d.style.width=w+'px'; d.style.height=h+'px';
      d.style.background=colors[Math.floor(Math.random()*colors.length)];
      d.style.left=(pRect.width/2 + (Math.random()*40-20))+'px'; d.style.top=(pRect.height*0.4 + (Math.random()*20-10))+'px';
      const ang=Math.random()*Math.PI*2, dist=Math.min(pRect.width,pRect.height)*(0.5+Math.random()*0.9);
      d.style.setProperty('--dx',(Math.cos(ang)*dist).toFixed(1)+'px'); d.style.setProperty('--dy',(Math.sin(ang)*dist).toFixed(1)+'px'); d.style.setProperty('--rz',((Math.random()*720-360)+'deg')); d.style.setProperty('--dur',(0.85+Math.random()*0.25)+'s');
      d.style.filter='drop-shadow(0 0 4px rgba(0,0,0,.12))'; layer.appendChild(d); setTimeout(()=>d.remove(),1100);
    } count++; if(count<bursts) setTimeout(fire,260); else setTimeout(()=>layer.remove(),1400); }; fire();
  }

  /* ---------- Random Ringï¼ˆèˆ‡ v2.1 ç›¸åŒçš„é«˜éš¨æ©Ÿæ„Ÿï¼‰ ---------- */
  const FAST_MS=700, MID_MS=650, SLOW_MS=750, LONG_JUMP_P=0.12, WARMUP_FLASH=5, FAKE_STOPS=2, CLICK_MIN_GAP=55;
  const toRC = no => ({ r: Math.ceil(no/10), c: ((no-1)%10)+1 });
  function tick(list, oi, lastClick){
    clearRolling(); const item=list[oi]; const seat=gridEl.querySelector(`.seat[data-key="${item.key}"]`); if(seat) seat.classList.add('_rolling');
    if(soundOn()){ const now=performance.now(); if(now-lastClick.v>CLICK_MIN_GAP){ if(audio && audio.state==='suspended' && audio.resume) audio.resume(); playClick(); lastClick.v=now; } }
    return item;
  }
  async function runDraw({mode,skipEmpty,avoidRepeats}){
    const list=getCandidates(mode,skipEmpty,avoidRepeats); if(!list.length){ alert('ç›®å‰æ²’æœ‰å¯æŠ½çš„å°è±¡ã€‚'); return null; }
    const target=list[Math.floor(Math.random()*list.length)];
    clearFinal();

    const n=list.length, perm=shuffle([...Array(n).keys()]);
    const idxOf = it => list.findIndex(x=>x.no===it.no);
    const tIdx = perm.findIndex(i=> i===idxOf(target));
    let ringPos=Math.floor(Math.random()*n), lastRC=null, lastClick={v:0};

    for(let i=0;i<WARMUP_FLASH;i++){ const oi=perm[Math.floor(Math.random()*n)]; const it=tick(list,oi,lastClick); lastRC=toRC(it.no); await sleep(45+Math.random()*20); }

    { const end=performance.now()+FAST_MS;
      while(performance.now()<end){
        ringPos = (ringPos+1)%n; let oi=perm[ringPos], rc=toRC(list[oi].no);
        if(lastRC && Math.abs(rc.r-lastRC.r)<=1 && Math.abs(rc.c-lastRC.c)<=1 && n>4){ ringPos=(ringPos+1)%n; oi=perm[ringPos]; rc=toRC(list[oi].no); }
        const it=tick(list,oi,lastClick); lastRC=toRC(it.no); await sleep(60+Math.random()*25);
      }
    }
    { const end=performance.now()+MID_MS;
      while(performance.now()<end){
        let step=1+(Math.random()*3|0); if(Math.random()<LONG_JUMP_P) step+=5+(Math.random()*5|0);
        ringPos=(ringPos+step)%n; let oi=perm[ringPos], rc=toRC(list[oi].no);
        if(lastRC && Math.abs(rc.r-lastRC.r)<=1 && Math.abs(rc.c-lastRC.c)<=1 && n>4){ ringPos=(ringPos+1)%n; oi=perm[ringPos]; }
        const it=tick(list,oi,lastClick); lastRC=toRC(it.no); await sleep(85+Math.random()*35);
      }
    }
    { const end=performance.now()+SLOW_MS; let fks=FAKE_STOPS;
      while(performance.now()<end){
        const step=1+(Math.random()*2|0); ringPos=(ringPos+step)%n;
        const it=tick(list,perm[ringPos],lastClick); lastRC=toRC(it.no);
        if(fks>0 && Math.random()<0.28){ fks--; await sleep(140+Math.random()*60); }
        await sleep(120+Math.random()*60);
      }
    }
    { const beats=[130,170,210,250,300,370]; const hops=((tIdx-ringPos)%n+n)%n || n; const base=Math.floor(hops/6), rem=hops%6; const per=[0,1,2,3,4,5].map(i=>base+(i<rem?1:0));
      for(let i=0;i<6;i++){ await sleep(beats[i]); for(let j=0;j<per[i];j++){ ringPos=(ringPos+1)%n; const it=tick(list,perm[ringPos],lastClick); lastRC=toRC(it.no); } }
    }

    const win=list[perm[ringPos]]; const seat=gridEl.querySelector(`.seat[data-key="${win.key}"]`);
    if(seat){ clearRolling(); seat.classList.add('_final','_winner-pulse','_celebrate'); launchConfettiOnSeat(seat,3,36); playWin(); }

    try{ const c=getActive(); if(c){ const entry={no:win.no,name:win.name||'',at:new Date().toISOString()}; if(!c.draws)c.draws={people:[],seats:[]}; if(mode==='person') c.draws.people.push(entry); else c.draws.seats.push(entry); scheduleSave(); renderHistory(); }}catch{}
    if(miniResult){ const showName = win.name?(' '+win.name):''; miniResult.textContent=`âœ… æŠ½ä¸­ï¼š${String(win.no).padStart(2,'0')}.${showName.trim()}`; }
    return win;
  }

  /* ---------- ç²¾ç°¡æ¢æŒ‰éˆ• ---------- */
  miniStart.addEventListener('click', async ()=>{
    const mode=(document.querySelector('input[name="miniMode"]:checked')?.value)||'person';
    const skipEmpty=$('#miniSkip')?.checked ?? true; const avoidRepeats=$('#miniAvoid')?.checked ?? true;
    miniStart.disabled=true; try{ await runDraw({mode,skipEmpty,avoidRepeats}); } finally{ miniStart.disabled=false; }
  });

  /* ---------- æŠ½é¸ç´€éŒ„é¢æ¿ï¼ˆç½®ä¸­ + æ¸…é™¤ï¼‰ ---------- */
  let mask=null, histPanel=null;
  function openHistory(){
    const c=getActive(); if(!c){ alert('å°šæœªé¸æ“‡ç­ç´š'); return; }
    // é®ç½©
    mask=document.createElement('div'); mask.className='mini-mask'; document.body.appendChild(mask);
    // é¢æ¿
    histPanel=document.createElement('div'); histPanel.className='mini-history';
    const rows=[];
    (c.draws?.people||[]).forEach(x=> rows.push({at:x.at||'',mode:'æŠ½äºº',no:x.no||'',name:x.name||''}));
    (c.draws?.seats||[]).forEach(x=> rows.push({at:x.at||'',mode:'æŠ½åº§ä½',no:x.no||'',name:x.name||''}));
    rows.sort((a,b)=>(b.at||'').localeCompare(a.at||''));
    const tr = rows.map(r=>`<tr><td class="muted">${r.at.replace('T',' ').replace('Z','')}</td><td>${r.mode}</td><td>${String(r.no).padStart(2,'0')}</td><td>${r.name}</td></tr>`).join('') || `<tr><td colspan="4" class="muted">å°šç„¡ç´€éŒ„</td></tr>`;
    histPanel.innerHTML = `
      <header>
        <div class="title">æœ¬ç­æŠ½é¸ç´€éŒ„</div>
        <div class="actions">
          <button class="btn danger" type="button" id="miniClear">æ¸…é™¤æŠ½é¸ç´€éŒ„</button>
          <button class="btn" type="button" id="miniClose">é—œé–‰</button>
        </div>
      </header>
      <div class="body">
        <table>
          <thead><tr><th>æ™‚é–“</th><th>æ¨¡å¼</th><th>åº§è™Ÿ</th><th>å§“å</th></tr></thead>
          <tbody>${tr}</tbody>
        </table>
      </div>
    `;
    document.body.appendChild(histPanel);

    const close = ()=>{ if(histPanel){ histPanel.remove(); histPanel=null; } if(mask){ mask.remove(); mask=null; } };
    histPanel.querySelector('#miniClose').addEventListener('click', close);
    mask.addEventListener('click', close);

    // æ¸…é™¤ç´€éŒ„
    histPanel.querySelector('#miniClear').addEventListener('click', ()=>{
      if(!confirm('ç¢ºå®šè¦æ¸…é™¤æœ¬ç­å…¨éƒ¨æŠ½é¸ç´€éŒ„å—ï¼Ÿï¼ˆæŠ½äºº/æŠ½åº§ä½éƒ½æœƒæ¸…ç©ºï¼‰')) return;
      const cc=getActive(); if(!cc) return;
      if(!cc.draws) cc.draws = {people:[],seats:[]}; else { cc.draws.people=[]; cc.draws.seats=[]; }
      try{ scheduleSave(); renderHistory(); }catch{}
      // æ›´æ–°é¢æ¿å…§å®¹
      const tbody = histPanel.querySelector('tbody');
      tbody.innerHTML = `<tr><td colspan="4" class="muted">å°šç„¡ç´€éŒ„</td></tr>`;
    });
  }
  miniHistoryBtn.addEventListener('click', openHistory);

  /* ---------- åŒ¯å‡º CSV ---------- */
  miniExport.addEventListener('click', ()=>{
    const c=getActive(); if(!c){ alert('å°šæœªé¸æ“‡ç­ç´š'); return; }
    const rows=[['æ™‚é–“ISO','ç­ç´š','æ¨¡å¼','åº§è™Ÿ','å§“å']], cls=c.name||'';
    (c.draws?.people||[]).forEach(x=>rows.push([x.at||'',cls,'æŠ½äºº',String(x.no||''),x.name||'']));
    (c.draws?.seats||[]).forEach(x=>rows.push([x.at||'',cls,'æŠ½åº§ä½',String(x.no||''),x.name||'']));
    const csv=rows.map(r=>r.map(s=>{const t=String(s??'');return /[",\n]/.test(t)?`"${t.replace(/"/g,'""')}"`:t;}).join(',')).join('\n');
    const blob=new Blob([new Uint8Array([0xEF,0xBB,0xBF]),csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
    const now=new Date(),pad=n=>String(n).padStart(2,'0'); const stamp=now.getFullYear()+pad(now.getMonth()+1)+pad(now.getDate())+'-'+pad(now.getHours())+pad(now.getMinutes())+pad(now.getSeconds());
    a.download=`class-${(c.name||'ç­ç´š')}-draws-${stamp}.csv`; a.href=URL.createObjectURL(blob); document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),2000);
  });

  /* ---------- ä¿éšªï¼šè‹¥ä»æ®˜ç•™èˆŠ start æŒ‰éˆ•å°±æ””æˆª ---------- */
  const legacyStart = document.getElementById('startDrawBtn');
  if(legacyStart){
    legacyStart.addEventListener('click', function(ev){
      ev.stopImmediatePropagation(); ev.preventDefault();
      const mode=(document.querySelector('input[name="drawMode"]:checked')?.value)||'person';
      const skipEmpty=document.getElementById('skipEmptySeat')?.checked ?? true;
      const avoidRepeats=document.getElementById('avoidRepeats')?.checked ?? true;
      legacyStart.disabled=true; (async()=>{ try{
        const res = await runDraw({mode,skipEmpty,avoidRepeats});
        const rn=document.getElementById('rollNow'), rs=document.getElementById('rollSub');
        if(res){ if(rn) rn.textContent=`âœ… æŠ½ä¸­ï¼š${String(res.no).padStart(2,'0')} ${res.name||''}`; if(rs) rs.textContent='æŠ½é¸å®Œæˆ'; }
      }finally{ legacyStart.disabled=false; } })();
    }, true);
  }
})();

</script>
<!-- === /æŠ½ç±¤å¢å¼· v2.2 === -->
<style id="danger-red-override">
  /* æŠ½é¸ç´€éŒ„ï¼šæ¸…é™¤ç´€éŒ„ â†’ ç´…åº•ç™½å­—ï¼ˆå« hoverï¼‰ */
  .mini-history .actions .danger{
    background:#ef4444 !important;   /* red-500 */
    border-color:#dc2626 !important;  /* red-600 */
    color:#fff !important;
  }
  .mini-history .actions .danger:hover{
    background:#dc2626 !important;    /* red-600 */
    border-color:#b91c1c !important;  /* red-700 */
  }
  .mini-history .actions .danger:focus{
    outline:2px solid #fecaca; 
    outline-offset:2px;
  }
</style>

</body>
</html>